<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#121212">
  <title>Registro de Temperaturas + Inventario + Planos (con seguridad)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase compat (v9 compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#121212; --panel:#1e1e1e; --panel-2:#151515;
      --accent:#00e5ff; --accent-2:#ffae00; --muted:#9aa9b1;
      --input-bg:#fff; --input-color:#000;
      --ok:#10b981; --warn:#f59e0b; --border:#2b2b2b; --soft:#222;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;color:#fff}
    .wrap{max-width:1180px;margin:12px auto;padding:12px}

    /* Header */
    .header-bar{display:flex;align-items:center;gap:10px;justify-content:center;position:relative;margin-bottom:10px}
    .header-title{color:var(--accent);font-weight:800;font-size:22px;text-align:center}
    .hamb{position:absolute;left:0;top:50%;transform:translateY(-50%);background:transparent;border:1px solid var(--soft);color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
    .hamb:active{filter:brightness(.9)}
    .authbar{position:absolute;right:0;top:50%;transform:translateY(-50%);display:flex;gap:8px;align-items:center}
    .authbar .role{font-size:12px;color:#9ad7ff}
    .authbar button{border:1px solid var(--soft);background:#0f0f0f;color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
    .authbar img{width:28px;height:28px;border-radius:50%;border:1px solid var(--soft)}

    /* Cards */
    .card{background:#1b1b1b;border:1px solid #2e2e2e;border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,.35);transition:transform .15s ease, box-shadow .2s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.5)}

    label{display:block;margin:6px 0 4px;font-weight:700;color:#ddd}
    input, select, textarea, button{box-sizing:border-box;border-radius:6px;border:1px solid var(--border);padding:8px}
    input,select,textarea{width:100%;background:var(--input-bg);color:var(--input-color)}
    input, select, textarea { background:#fff; color:#000; border:1px solid #ccc }

    button{cursor:pointer;border:none;font-weight:700}
    .btn-primary{background:var(--accent);color:#000}
    .btn-outline{background:transparent;border:2px solid var(--accent);color:var(--accent)}
    .btn-danger{background:var(--accent-2);color:#000}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .actions{display:flex;gap:10px;align-items:center}
    .hint{color:var(--muted);font-size:13px;margin-top:8px}
    .table-wrap{overflow:auto;margin-top:12px;border-radius:8px;border:1px solid var(--soft)}
    table{width:100%;border-collapse:collapse;background:transparent}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:center;color:#eee}
    th{background:#171717}
    td input{width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;background:#fff;color:#000}
    .btn-row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    canvas{width:100% !important;height:360px !important;background:#151515;border-radius:6px}
    .cabecera{color:var(--muted);font-size:13px;margin-top:10px}
    .hidden{display:none!important}

    /* Drawer */
    .drawer-mask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:900}
    .drawer{position:fixed;right:0;top:0;height:100%;width:320px;max-width:92vw;background:#0f0f0f;border-left:1px solid var(--soft);transform:translateX(100%);transition:transform .25s ease;z-index:1000;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer .head{padding:14px;border-bottom:1px solid var(--soft);font-weight:800;color:#fff;display:flex;justify-content:space-between;align-items:center}
    .drawer .head button{background:transparent;color:#fff;border:1px solid var(--soft)}
    .drawer .body{padding:10px;display:flex;flex-direction:column;gap:8px}
    .drawer .opt{background:#121212;border:1px solid var(--soft);padding:12px;border-radius:10px;cursor:pointer}
    .drawer .opt:hover{filter:brightness(1.05)}
    .drawer small{color:#9aa9b1}

    /* Inventario toolbar + tabs */
    .inv-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .inv-pill{background:#161616;border:1px solid var(--soft);border-radius:10px;padding:6px 8px;display:flex;gap:8px;align-items:center}
    .inv-pill label{margin:0;color:#cfeaf0;font-weight:700}
    .inv-toolbar select,.inv-toolbar input[type="text"]{border:1px solid #ccc;border-radius:8px;padding:6px 8px;background:#fff;color:#000;min-width:140px}
    .inv-btn{border:1px solid var(--soft);background:#0f0f0f;border-radius:8px;padding:8px 12px;cursor:pointer;color:#fff}
    .inv-btn.primary{background:var(--accent);color:#000;border-color:var(--accent);font-weight:800}
    .inv-info{font-size:12px;color:#b4c1c8}
    .inv-tabs{display:flex;gap:8px;margin:10px 0 14px}
    .inv-tab{border:1px solid var(--soft);background:#0f0f0f;border-radius:999px;padding:6px 12px;cursor:pointer}
    .inv-tab.active{background:var(--accent);color:#000;border-color:var(--accent);font-weight:800}

    /* Inventario tarjetas */
    .inv-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:10px}
    .inv-card{background:#1b1b1b;border:1px solid #2e2e2e;border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 6px rgba(0,0,0,.35);transition:transform .15s ease, box-shadow .2s ease}
    .inv-card:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.5)}
    .inv-head{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .inv-head .m{font-weight:800;color:#00e5ff}
    .inv-meta{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12.5px;color:#e1e1e1}
    .inv-meta b{color:#bfefff}
    .badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;border:1px solid var(--soft);background:#0f0f0f;color:#cfeaf0}
    .inv-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:2px}
    .btn-mini{border:1px solid var(--soft);background:#0f0f0f;border-radius:10px;padding:7px 10px;cursor:pointer;font-size:13px;color:#fff}
    .btn-mini.ok{background:var(--ok);color:#000;border-color:var(--ok);font-weight:800}
    .btn-mini.rev{background:#0b2a30;border-color:#0d3f47}
    .btn-mini.warn{background:#222}

    .totales-bar{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0}
    .t-chip{background:#171717;border:1px solid #2b2b2b;border-radius:10px;padding:8px 10px;color:#e1e1e1;box-shadow:0 1px 4px rgba(0,0,0,.4)}
    .t-chip b{color:#bfefff}
    .t-chip .pct{font-weight:800;color:#00e676}

    .kpi-por-mac{margin:8px 0 2px;color:#9aa9b1;font-size:12px}
    .kpi-por-mac b{color:#cfeaf0}

    /* Modal generico */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:1200}
    .win{background:#1a1a1a;border:1px solid #333;border-radius:14px;max-width:980px;width:98vw;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;color:#fff;box-shadow:0 4px 14px rgba(0,0,0,.7)}
    .win .head{padding:10px;border-bottom:1px solid var(--soft);display:flex;justify-content:space-between;align-items:center}
    .win .body{padding:10px;overflow:auto}
    .close{border:1px solid var(--soft);background:#151515;border-radius:8px;padding:6px 10px;cursor:pointer;color:#fff}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:6px;font-size:13px}
    .kv b{color:#bfefff}
    .modal .actions{padding:10px;border-top:1px solid var(--soft);display:flex;gap:8px}
    .modal input, .modal textarea, .modal select{background:#fff;color:#000;border:1px solid #ccc}

    /* Vista tabla agrupada */
    #viewTabla table th, #viewTabla table td {
      border-bottom: 1px solid var(--border);
      text-align: center;
      padding: 8px;
      color: #eee;
      font-size: 14px;
    }
    #viewTabla table th { background:#171717;color:var(--accent);font-weight:700 }
    #viewTabla .btn-mini{ padding:4px 8px;font-size:13px }
    #viewTabla select{ background:#fff;color:#000;border-radius:6px;padding:6px }
    #viewTabla { padding-bottom:20px }
    .grupoTabla{ margin-bottom:22px;background:var(--panel);border-radius:12px;padding:10px;box-shadow:0 0 6px rgba(0,0,0,0.3) }
    .titulo-grupo{ margin:0 0 8px 4px;font-size:15px;color:var(--accent);text-transform:uppercase;font-weight:bold;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .tabla-grupo{ width:100%;border-collapse:collapse;border-radius:10px;overflow:hidden;display:block }
    .tabla-grupo thead{ background:#171717;display:block;border-bottom:2px solid var(--accent) }
    .tabla-grupo tbody{ display:block }
    .tabla-grupo tr{ display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));border-bottom:1px solid var(--border);padding:4px 0 }
    .tabla-grupo th,.tabla-grupo td{ text-align:center;font-size:14px;padding:6px;color:#e0e0e0;word-break:break-word;white-space:normal }
    .tabla-grupo tr:nth-child(even){ background:rgba(255,255,255,0.03) }
    .acciones-cell{ display:flex;justify-content:center;align-items:center;gap:8px }
    .btn-mini.ok{ background:#00c853;color:#fff }
    .btn-mini.warn{ background:#ffab00;color:#000 }
    .btn-mini.confirmed{ animation:confirmPulse .4s ease;background:#1de9b6 !important }
    @keyframes confirmPulse{0%{transform:scale(1);box-shadow:0 0 0 rgba(0,255,0,.6)}50%{transform:scale(1.1);box-shadow:0 0 12px rgba(0,255,0,.8)}100%{transform:scale(1);box-shadow:0 0 0 rgba(0,255,0,0)}}

    /* Planos */
    .planos-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .pl-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
    .pl-card{background:#161616;border:1px solid #303030;border-radius:12px;padding:10px}
    .pl-title{font-weight:800;color:#bfefff;margin-bottom:6px}
    .pl-meta{font-size:12.5px;color:#d8d8d8;display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .pl-actions{display:flex;gap:8px;margin-top:8px}
    .imgbox{max-height:70vh;overflow:auto;background:#0b0b0b;border:1px solid #2b2b2b;border-radius:10px;padding:6px}
    .imgbox img{max-width:100%;height:auto;display:block;margin:auto}

    /* Admin */
    .admin-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .pill{display:inline-block;border:1px solid var(--soft);border-radius:999px;padding:3px 8px;font-size:12px;color:#cfeaf0;background:#0f0f0f;margin-left:6px}

    /* Responsive */
    @media (max-width:900px){
      .grid4{grid-template-columns:repeat(2,1fr)}
      canvas{height:320px !important}
    }
    @media (max-width:520px){
      .grid4{grid-template-columns:1fr}
      .actions{flex-direction:column;align-items:stretch}
      .admin-grid{grid-template-columns:1fr}
    }
    @media (max-width:768px){
      .inv-grid{grid-template-columns:1fr !important}
      .inv-card{padding:10px;border-radius:12px}
      .inv-meta{grid-template-columns:1fr !important;font-size:12px}
      .inv-head .m{font-size:14px}
      .inv-actions{flex-direction:column;align-items:stretch}
      .btn-mini{width:100%;font-size:13px;padding:8px}
      .inv-pill{flex-direction:column;align-items:flex-start}
      .inv-toolbar{flex-direction:column;align-items:stretch}
      .inv-toolbar select,.inv-toolbar input[type="text"]{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="header-bar">
      <button class="hamb" id="btnMenu">‚ò∞</button>
      <div class="header-title" id="topTitle">Registro de Temperaturas</div>
      <div class="authbar" id="authbar">
        <span id="authInfo" class="role">No autenticado</span>
        <button id="btnLogin">Iniciar con Google</button>
      </div>
    </div>

    <!-- ======== Vista: Registro de Temperaturas ======== -->
    <div id="view-temperaturas">
      <div class="card">
        <div class="grid4">
          <div>
            <label for="horno">Horno</label>
            <select id="horno">
              <option value="">-- Selecciona --</option>
              <option>Horno 5</option><option>Horno 7-3</option><option>Horno 9-1</option>
              <option>Horno 9-2</option><option>Horno Italiano</option><option>Horno 7-4</option>
              <option>Horno 7-5</option><option>Horno 9-3</option><option>Horno 10</option>
            </select>
          </div>
          <div>
            <label for="fecha">Fecha</label>
            <input type="date" id="fecha">
          </div>
          <div>
            <label for="turno">Turno</label>
            <select id="turno">
              <option value="">-- Selecciona --</option>
              <option value="T1">T1</option><option value="T2">T2</option>
            </select>
          </div>
          <div>
            <label for="selActivos">Ciclos activos</label>
            <select id="selActivos"><option value="">-- Ninguno --</option></select>
          </div>
        </div>

        <div class="grid4" style="margin-top:12px">
          <div>
            <label for="horaInicio">Hora inicio</label>
            <input type="time" id="horaInicio">
          </div>
          <div>
            <label for="horaFin">Hora fin (auto +10h)</label>
            <input type="time" id="horaFin">
          </div>
          <div>
            <label for="operarioInicio">Operario (inicia)</label>
            <input type="text" id="operarioInicio" placeholder="nombre">
          </div>
          <div class="actions">
            <div style="width:100%">
              <label style="visibility:hidden">actions</label>
              <div style="display:flex;gap:8px">
                <button id="btnNuevo" class="btn-primary">Iniciar ciclo</button>
                <button id="btnRecargar" class="btn-outline">Recargar ciclos</button>
              </div>
            </div>
          </div>
        </div>
        <div class="hint">Si existe un ciclo activo (mismo Horno/Fecha/Turno) aparecer√° en "Ciclos activos".</div>
      </div>

      <div class="card">
        <h3 style="color:var(--accent);margin:0 0 12px">Agregar lecturas por hora</h3>
        <div class="table-wrap">
          <table id="tabla">
            <thead>
              <tr><th>Hora</th><th>Zona 1</th><th>Zona 2</th><th>Zona 3</th><th>Zona 4</th><th>SetPoint</th><th>Quitar</th></tr>
            </thead>
            <tbody id="tbody">
              <tr>
                <td><input type="time" class="hora"></td>
                <td><input type="number" class="zona1" step="0.1"></td>
                <td><input type="number" class="zona2" step="0.1"></td>
                <td><input type="number" class="zona3" step="0.1"></td>
                <td><input type="number" class="zona4" step="0.1"></td>
                <td><input type="number" class="setPoint" step="0.1"></td>
                <td><button class="del" type="button" style="background:var(--accent);color:#000">‚úï</button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="btn-row">
          <button id="btnAgregarFila" class="btn-primary" type="button">Agregar lectura</button>
          <button id="btnGuardar" class="btn-primary" type="button">Guardar lecturas</button>
          <button id="btnFinalizar" class="btn-danger" type="button">Finalizar ciclo</button>
        </div>
      </div>

      <div class="card">
        <h3 style="color:var(--accent);margin:0 0 12px">Gr√°fica del ciclo seleccionado (en tiempo real)</h3>
        <canvas id="chart"></canvas>
        <div class="cabecera" id="cabecera"></div>
      </div>
    </div>

    <!-- ======== Vista: Inventario ======== -->
    <div id="view-inventario" class="hidden">
      <div class="card" style="background:var(--panel-2)">
        <div class="inv-toolbar">
          <div class="inv-pill">
            <label>Planta</label>
            <select id="fPlanta">
              <option value="">Todas</option>
              <option>A1</option><option>A2</option><option>A3</option><option>OTRA</option>
            </select>
            <label>M√°quina</label>
            <select id="fMaquina"><option value="">Todas</option></select>
          </div>
          <div class="inv-pill">
            <label>Buscar</label>
            <input id="fBuscar" type="text" placeholder="soitem, part, desc...">
          </div>
          <div class="inv-pill">
            <label>Ordenar</label>
            <select id="fOrden">
              <option value="fecha_desc">Fecha reciente</option>
              <option value="fecha_asc">Fecha antigua</option>
              <option value="machine">M√°quina</option>
              <option value="part">Part</option>
              <option value="kg_desc">Kg ‚Üì</option>
              <option value="kg_asc">Kg ‚Üë</option>
              <option value="desc">Descripci√≥n (A-Z)</option>
              <option value="desc_rev">Descripci√≥n (Z-A)</option>
            </select>
          </div>
          <button class="inv-btn" id="btnActualizarInv">Actualizar</button>
          <div class="inv-info" id="ultimaInfoInv">√öltima actualizaci√≥n: -</div>
          <button class="inv-btn" id="btnVistaToggle">üìã Vista Tabla</button>
          <div class="inv-info"><b>Turno actual:</b> <span id="lblTurno">-</span></div>
        </div>

        <div class="inv-tabs">
          <div class="inv-tab active" id="tabPend">Pendientes</div>
          <div class="inv-tab" id="tabRevis">Revisados</div>
          <div class="inv-tab" id="tabHist">Historial</div>
        </div>

        <div class="totales-bar" id="totalesBar">
          <div class="t-chip"><b>Total general:</b> <span id="tTotalGeneral">0</span> Kg</div>
          <div class="t-chip"><b>Pendientes por revisar:</b> <span id="tPendientes">0</span> Kg</div>
          <div class="t-chip"><b>Revisados:</b> <span id="tRevisados">0</span> Kg</div>
          <div class="t-chip"><b>Avance:</b> <span class="pct" id="tAvance">0%</span></div>
        </div>

        <div class="kpi-por-mac" id="kpiPorMac"></div>
      </div>

      <div id="listPend" class="inv-grid"></div>
      <div id="listRevis" class="inv-grid hidden"></div>
      <div id="listHist" class="inv-grid hidden"></div>
    </div>

    <!-- ======== Vista: Tabla Agrupada de Pendientes ======== -->
    <div id="viewTabla" class="hidden">
      <div class="card" style="background:var(--panel-2)">
        <div class="inv-toolbar" style="justify-content:space-between;align-items:center">
          <div class="inv-pill">
            <label>Agrupar por</label>
            <select id="agrupacionTabla">
              <option value="part">Part</option>
              <option value="desc">Descripci√≥n</option>
            </select>
          </div>
          <button class="inv-btn primary" id="btnRecargarTabla">üîÑ Recargar</button>
        </div>
        <div class="table-wrap" id="tablaAgrupada"></div>
      </div>
    </div>

    <!-- ======== Vista: Planos ======== -->
    <div id="view-planos" class="hidden">
      <div class="card" style="background:var(--panel-2)">
        <div class="planos-toolbar">
          <div class="inv-pill">
            <label>Buscar</label>
            <input id="plBuscar" type="text" placeholder="C√≥digo, descripci√≥n, cliente...">
          </div>
          <div class="inv-pill">
            <label>Zona</label>
            <select id="plZona">
              <option value="">Cualquiera</option>
              <option>A1</option><option>A2</option><option>A3</option><option>OTRA</option>
            </select>
          </div>
          <button class="inv-btn primary" id="btnCargarPlanos">Actualizar planos</button>
          <div class="inv-info" id="plInfo">Origen: Excel publicado (CSV) o Firebase fallback</div>
        </div>
        <div class="pl-grid" id="plGrid"></div>
      </div>
    </div>

    <!-- ======== Vista: Admin ======== -->
    <div id="view-admin" class="hidden">
      <div class="card">
        <h3 style="margin:0 0 10px">Panel de administraci√≥n</h3>
        <div class="inv-info">Solo visible para <b>admin</b>/<b>superadmin</b>. Puedes administrar usuarios, roles y zonas permitidas.</div>
      </div>

      <div class="card">
        <div class="admin-grid">
          <div>
            <h4>Usuarios y roles</h4>
            <div class="inv-pill">
              <label>Correo</label>
              <input id="adEmail" type="email" placeholder="usuario@empresa.com">
            </div>
            <div class="inv-pill">
              <label>Rol</label>
              <select id="adRol">
                <option value="user">user</option>
                <option value="admin">admin</option>
                <option value="superadmin">superadmin</option>
              </select>
            </div>
            <div class="inv-pill">
              <label>Zona</label>
              <select id="adZona">
                <option value="">(sin restricci√≥n)</option>
                <option>A1</option><option>A2</option><option>A3</option><option>OTRA</option>
              </select>
            </div>
            <div class="btn-row">
              <button class="btn-primary" id="btnAsignar">Asignar / Actualizar</button>
              <button class="btn-danger" id="btnEliminar">Eliminar usuario (roles)</button>
            </div>
            <div class="hint">* Si el usuario a√∫n no inici√≥ sesi√≥n nunca, quedar√° pre-registrado por correo. Al iniciar, tomar√° su rol/zona.</div>
          </div>

          <div>
            <h4>Listado</h4>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Correo</th><th>Rol</th><th>Zona</th><th>UID</th></tr></thead>
                <tbody id="tbUsers"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h4>Seguridad actual</h4>
        <div id="secInfo">-</div>
      </div>
    </div>
  </div>

  <!-- ===== Modal Inventario ===== -->
  <div class="modal" id="modalInv">
    <div class="win" role="dialog" aria-modal="true">
      <div class="head">
        <div><b id="mdTitulo">Detalle</b></div>
        <button class="close" id="btnCloseInv">Cerrar</button>
      </div>
      <div class="body">
        <div class="kv">
          <b>SOITEM</b><div id="mdSoitem"></div>
          <b>Part</b><div id="mdPart"></div>
          <b>Descripci√≥n</b><div id="mdDesc"></div>
          <b>Prioridad</b><div id="mdPrio"></div>
          <b>Longitud</b><div id="mdLong"></div>
          <b>Pzs Pend</b><div id="mdPzs"></div>
          <b>Kg Pend</b><div id="mdKg"></div>
          <b>M√°quina</b><div id="mdMac"></div>
          <b>Planta</b><div id="mdPlanta"></div>
          <b>Fecha</b><div id="mdFec"></div>
        </div>

        <hr style="margin:10px 0;border:0;border-top:1px solid var(--soft)">

        <div class="kv">
          <b>Comentario</b>
          <div><input id="mdCmt" type="text" placeholder="Agregar/editar comentario..."></div>

          <b>Trazabilidad</b>
          <div id="mdTrace" style="font-size:12.5px;color:#ddd">(sin registros)</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn-mini warn" id="btnGuardarCmt">üí¨ Guardar comentario</button>
        <button class="btn-mini ok" id="btnOk">‚úÖ OK</button>
        <button class="btn-mini rev" id="btnRegresar">‚Ü©Ô∏è Regresar a pendientes</button>
      </div>
    </div>
  </div>

  <!-- ===== Modal Planos ===== -->
  <div class="modal" id="modalPlano">
    <div class="win" role="dialog" aria-modal="true">
      <div class="head">
        <div><b id="plTitulo">Plano</b> <span id="plChips"></span></div>
        <button class="close" id="btnClosePlano">Cerrar</button>
      </div>
      <div class="body">
        <div class="imgbox"><img id="plImg" alt="Plano"></div>
      </div>
    </div>
  </div>

  <!-- ===== Drawer ===== -->
  <div class="drawer-mask" id="drawerMask"></div>
  <div class="drawer" id="drawer">
    <div class="head">
      <span>Men√∫ principal</span>
      <button id="btnCloseDrawer">‚úï</button>
    </div>
    <div class="body">
      <div class="opt" data-target="temperaturas">
        <b>Registro de Temperaturas</b><br>
        <small>Lecturas por zona y ciclo</small>
      </div>
      <div class="opt" data-target="inventario">
        <b>Inventario Por Templar</b><br>
        <small>Gesti√≥n y trazabilidad</small>
      </div>
      <div class="opt" data-target="planos">
        <b>Planos</b><br>
        <small>Buscador y visor</small>
      </div>
      <div class="opt" data-target="admin">
        <b>Administraci√≥n</b><br>
        <small>Usuarios, roles y zonas</small>
      </div>
    </div>
  </div>

<script>
"use strict";

/* ==================== CONFIG ==================== */
const SUPERADMIN_EMAIL = "gary.maldonado@tecnoglass.com";

/* CSV publicado (Excel/Sheets) con columnas:
   codigo, descripcion, cliente, zona, url (imagen/pdf), coords(optional JSON: [{"x":..,"y":..,"label":"..."}])
   Si lo dejas "", se usar√° fallback de Firebase /planos */
const PLANOS_SHEET_CSV_URL = ""; // ‚Üê si tienes el CSV publicado, p√©galo aqu√≠

/* API producci√≥n (igual que tu versi√≥n funcional) */
const API_URL="https://optima.tecnoglass.net/api/alutions_production/reports-producion/Detalle-produccion";

/* ==================== Firebase ==================== */
const firebaseConfig = {
  apiKey: "AIzaSyAB4UlwaVJzc4U4VbmddLf4mejKAOvTufw",
  authDomain: "hornosapp-60887.firebaseapp.com",
  databaseURL: "https://hornosapp-60887-default-rtdb.firebaseio.com",
  projectId: "hornosapp-60887",
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
const dbInv = db.ref("inventarioPorTemplar");     // ya lo usabas
const dbRoles = db.ref("roles");                  // {uid:{email,role,zone}}
const dbUsers = db.ref("usersDirectory");         // √≠ndice por email -> uid
const dbPlanos = db.ref("planos");                // fallback (si no hay CSV)

/* ==================== Helpers globales ==================== */
const $ = id => document.getElementById(id);
const pad2 = n => String(n).padStart(2,'0');
const hoyISO = () => new Date().toISOString().slice(0,10);
function addHoursToHHMM(hhmm, plus=10){
  if(!hhmm) return "";
  const [h,m] = hhmm.split(':').map(Number);
  const dt = new Date(); dt.setHours(h||0,m||0,0,0); dt.setHours(dt.getHours()+plus);
  return pad2(dt.getHours())+':'+pad2(dt.getMinutes());
}
function horaAhoraHHMM(){ const d = new Date(); return pad2(d.getHours())+':'+pad2(d.getMinutes()); }
function toAMPM(hhmm){
  if(!hhmm) return '';
  const [h,m] = hhmm.split(':').map(Number);
  let hour = h % 12 || 12; const ampm = h >= 12 ? 'PM' : 'AM';
  return `${hour}:${pad2(m)} ${ampm}`;
}
const toNum = v => isNaN(+v)?0:+v;
function fFecha(iso){ if(!iso) return ""; const d=new Date(iso); if(isNaN(d)) return ""; return d.toLocaleString("es-CO",{hour12:true}); }

/* ==================== Estado Auth/Security ==================== */
let currentUser = null;
let currentRole = null;     // 'user' | 'admin' | 'superadmin'
let currentZone = "";       // '' | A1 | A2 | A3 | OTRA

function updateAuthBar(){
  const info = $('authInfo');
  const btnLogin = $('btnLogin');
  if(!currentUser){
    info.textContent = 'No autenticado';
    btnLogin.textContent = 'Iniciar con Google';
    btnLogin.onclick = loginGoogle;
  } else {
    const txt = `${currentUser.email} ¬∑ ${currentRole || 'user'}${currentZone? ' ¬∑ ' + currentZone : ''}`;
    info.innerHTML = txt;
    btnLogin.textContent = 'Salir';
    btnLogin.onclick = ()=> auth.signOut();
  }
}

/* ===== Login Google ===== */
async function loginGoogle(){
  const provider = new firebase.auth.GoogleAuthProvider();
  await auth.signInWithPopup(provider);
}

/* ===== Carga / creaci√≥n de rol ===== */
async function ensureRole(user){
  // directorio por email
  await dbUsers.child(escapeEmail(user.email)).set({uid:user.uid,email:user.email});
  const roleSnap = await dbRoles.child(user.uid).once('value');
  let roleDoc = roleSnap.val();

  // superadmin autom√°tico por correo configurado
  if(user.email.toLowerCase() === SUPERADMIN_EMAIL.toLowerCase()){
    roleDoc = roleDoc || {};
    roleDoc.email = user.email;
    roleDoc.role = 'superadmin';
    roleDoc.zone = '';
    await dbRoles.child(user.uid).set(roleDoc);
    return roleDoc;
  }

  // si hay pre-registro por email (hecho desde admin), tomarlo
  const preregSnap = await db.ref('preUsers').child(escapeEmail(user.email)).once('value');
  if(preregSnap.exists()){
    const pr = preregSnap.val();
    roleDoc = roleDoc || {};
    roleDoc.email = user.email;
    roleDoc.role = pr.role || 'user';
    roleDoc.zone = pr.zone || '';
    await Promise.all([
      dbRoles.child(user.uid).set(roleDoc),
      db.ref('preUsers').child(escapeEmail(user.email)).remove()
    ]);
    return roleDoc;
  }

  // si no existe nada, default user sin zona
  if(!roleDoc){
    roleDoc = {email:user.email,role:'user',zone:''};
    await dbRoles.child(user.uid).set(roleDoc);
  }
  return roleDoc;
}

function escapeEmail(email){ return (email||'').replaceAll('.', ','); }

/* ===== Gate de seguridad ===== */
function canUseAPI(){
  // API (inventario) permitido a: superadmin, admin, o user con zona asignada (cualquiera)
  if(!currentUser) return false;
  if(currentRole === 'superadmin' || currentRole === 'admin') return true;
  return !!currentZone;
}
function canViewPlanos(plano){
  // Ver planos si: superadmin, admin, o user cuya zona == plano.zona (o plano sin zona)
  if(!currentUser) return false;
  if(currentRole === 'superadmin' || currentRole === 'admin') return true;
  if(!plano || !plano.zona) return !!currentZone;
  return currentZone ? (plano.zona.toUpperCase() === currentZone.toUpperCase()) : false;
}

/* ==================== Auth state ==================== */
auth.onAuthStateChanged(async (user)=>{
  currentUser = user || null;
  if(user){
    const roleDoc = await ensureRole(user);
    currentRole = roleDoc.role || 'user';
    currentZone = roleDoc.zone || '';
    $('secInfo').innerHTML = `Autenticado como <b>${user.email}</b> <span class="pill">${currentRole}</span> ${currentZone? '<span class="pill">Zona '+currentZone+'</span>':''}`;
    $('authbar').insertAdjacentHTML('beforeend', user.photoURL? `<img src="${user.photoURL}">` : '');
    loadUsersTableIfAdmin();
  }else{
    currentRole = null; currentZone = '';
    $('secInfo').innerHTML = 'No autenticado';
    $('tbUsers').innerHTML = '';
  }
  updateAuthBar();
  // refrescar vistas protegidas
  setTimeout(()=>{
    if(viewKey==='inventario') maybeLoadInventario();
    if(viewKey==='planos') cargarPlanos();
  },100);
});

/* ==================== NAV ==================== */
const drawer = $('drawer'), mask=$('drawerMask');
$('btnMenu').onclick = ()=>{ drawer.classList.add('open'); mask.style.display='block'; };
$('btnCloseDrawer').onclick = closeDrawer;
$('drawerMask').onclick = closeDrawer;
function closeDrawer(){ drawer.classList.remove('open'); mask.style.display='none'; }

let viewKey='temperaturas';
document.querySelectorAll(".drawer .opt").forEach(opt=>{
  opt.addEventListener("click",()=>{
    const target = opt.dataset.target;
    showView(target);
    closeDrawer();
  });
});
function showView(key){
  viewKey = key;
  const map={
    temperaturas:'view-temperaturas',
    inventario:'view-inventario',
    planos:'view-planos',
    admin:'view-admin'
  };
  Object.values(map).forEach(id=> $(id).classList.add('hidden'));
  $(map[key]).classList.remove('hidden');
  $('topTitle').textContent = (
    key==='temperaturas' ? 'Registro de Temperaturas' :
    key==='inventario' ? 'Inventario Por Templar' :
    key==='planos' ? 'Planos' : 'Administraci√≥n'
  );
  if(key==='inventario') maybeLoadInventario();
  if(key==='planos') cargarPlanos();
  if(key==='admin') loadUsersTableIfAdmin();
}

/* ==================== TEMPERATURAS (tu l√≥gica intacta) ==================== */
let currentCicloId = "";
let liveRef = null;

/* Defaults Temperaturas */
$('fecha').value = hoyISO();
$('horaInicio').value = horaAhoraHHMM();
$('horaFin').value = addHoursToHHMM($('horaInicio').value,10);
$('horno').value = '';
$('turno').value = '';
$('operarioInicio').value = '';
$('selActivos').innerHTML = '<option value="">-- Ninguno --</option>';

/* Tabla lecturas: quitar fila */
function bindDeletes(){
  document.querySelectorAll('#tbody .del').forEach(btn=>{
    btn.onclick = ()=> btn.closest('tr').remove();
  });
}
bindDeletes();

/* Agregar fila lectura */
$('btnAgregarFila').onclick = ()=>{
  const now = horaAhoraHHMM();
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="time" class="hora" value="${now}"></td>
    <td><input type="number" class="zona1" step="0.1"></td>
    <td><input type="number" class="zona2" step="0.1"></td>
    <td><input type="number" class="zona3" step="0.1"></td>
    <td><input type="number" class="zona4" step="0.1"></td>
    <td><input type="number" class="setPoint" step="0.1"></td>
    <td><button class="del" type="button" style="background:var(--accent);color:#000">‚úï</button></td>
  `;
  $('tbody').appendChild(tr);
  bindDeletes();
};

/* Chart temperaturas */
const chart = new Chart($('chart').getContext('2d'), {
  type:'line',
  data:{ labels: [], datasets:[
    {label:'Zona 1', data:[], borderColor:'red', fill:false, tension:0.2},
    {label:'Zona 2', data:[], borderColor:'green', fill:false, tension:0.2},
    {label:'Zona 3', data:[], borderColor:'blue', fill:false, tension:0.2},
    {label:'Zona 4', data:[], borderColor:'purple', fill:false, tension:0.2},
    {label:'SetPoint', data:[], borderColor:'orange', borderDash:[6,4], fill:false, tension:0}
  ]},
  options:{responsive:true,maintainAspectRatio:false,animation:false}
});

/* Cargar ciclos activos en select */
async function cargarActivosSelect(){
  const horno = $('horno').value, fecha = $('fecha').value, turno = $('turno').value;
  const snap = await db.ref('ciclosActivos').once('value');
  const sel = $('selActivos');
  sel.innerHTML = `<option value="">-- Ninguno --</option>`;
  snap.forEach(ch=>{
    const meta = ch.val().meta || {};
    if(meta.horno === horno && meta.fecha === fecha && meta.turno === turno){
      const opt = document.createElement('option');
      opt.value = ch.key;
      opt.textContent = `${meta.horno} ‚Ä¢ ${meta.fecha} ‚Ä¢ ${meta.turno} ‚Ä¢ ${meta.horaInicio||'--'}`;
      sel.appendChild(opt);
    }
  });
}
$('btnRecargar').addEventListener('click', cargarActivosSelect);
['horno','fecha','turno'].forEach(id=> $(id).addEventListener('change', cargarActivosSelect));

function detachLive(){
  if(liveRef){ liveRef.off(); liveRef=null; }
  chart.data.labels=[]; chart.data.datasets.forEach(ds=>ds.data=[]); chart.update();
  $('cabecera').textContent='';
  currentCicloId="";
}
function attachLive(cicloId){
  detachLive();
  if(!cicloId) return;
  currentCicloId=cicloId;

  db.ref(`ciclosActivos/${cicloId}/meta`).once('value').then(s=>{
    const meta=s.val()||{};
    $('horaInicio').value=meta.horaInicio||horaAhoraHHMM();
    $('horaFin').value=meta.horaFin||addHoursToHHMM(meta.horaInicio||horaAhoraHHMM(),10);
    $('operarioInicio').value=meta.operarioInicio||'';
    $('cabecera').textContent=`Ciclo: ${meta.horno||''} | ${meta.fecha||''} | ${meta.turno||''}`;
  });

  liveRef=db.ref(`ciclosActivos/${cicloId}/lecturas`);
  liveRef.on('value', snap=>{
    const arr=[];
    snap.forEach(ch=>{
      const v=ch.val()||{};
      arr.push({
        hora: v.hora || horaAhoraHHMM(),
        zona1: v.zona1 ?? '',
        zona2: v.zona2 ?? '',
        zona3: v.zona3 ?? '',
        zona4: v.zona4 ?? '',
        setPoint: v.setPoint ?? ''
      });
    });
    arr.sort((a,b)=>a.hora.localeCompare(b.hora));

    chart.data.labels = arr.map(r => toAMPM(r.hora));
    chart.data.datasets[0].data = arr.map(r => (r.zona1!=='' && r.zona1!=null && !isNaN(r.zona1)) ? Number(r.zona1) : null);
    chart.data.datasets[1].data = arr.map(r => (r.zona2!=='' && r.zona2!=null && !isNaN(r.zona2)) ? Number(r.zona2) : null);
    chart.data.datasets[2].data = arr.map(r => (r.zona3!=='' && r.zona3!=null && !isNaN(r.zona3)) ? Number(r.zona3) : null);
    chart.data.datasets[3].data = arr.map(r => (r.zona4!=='' && r.zona4!=null && !isNaN(r.zona4)) ? Number(r.zona4) : null);
    chart.data.datasets[4].data = arr.map(r => (r.setPoint!=='' && r.setPoint!=null && !isNaN(r.setPoint)) ? Number(r.setPoint) : null);
    chart.update();

    const tbody = $('tbody');
    tbody.innerHTML = '';
    if(arr.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="time" class="hora" value="${horaAhoraHHMM()}"></td>
        <td><input type="number" class="zona1" step="0.1"></td>
        <td><input type="number" class="zona2" step="0.1"></td>
        <td><input type="number" class="zona3" step="0.1"></td>
        <td><input type="number" class="zona4" step="0.1"></td>
        <td><input type="number" class="setPoint" step="0.1"></td>
        <td><button class="del" type="button" style="background:var(--accent);color:#000">‚úï</button></td>`;
      tbody.appendChild(tr);
    } else {
      arr.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="time" class="hora" value="${r.hora}"></td>
          <td><input type="number" class="zona1" step="0.1" value="${r.zona1}"></td>
          <td><input type="number" class="zona2" step="0.1" value="${r.zona2}"></td>
          <td><input type="number" class="zona3" step="0.1" value="${r.zona3}"></td>
          <td><input type="number" class="zona4" step="0.1" value="${r.zona4}"></td>
          <td><input type="number" class="setPoint" step="0.1" value="${r.setPoint}"></td>
          <td><button class="del" type="button" style="background:var(--accent);color:#000">‚úï</button></td>`;
        tbody.appendChild(tr);
      });
    }
    bindDeletes();
  });
}
$('selActivos').addEventListener('change',e=>{
  const id=e.target.value;
  if(!id){ detachLive(); return; }
  attachLive(id);
});

/* Iniciar ciclo */
$('btnNuevo').addEventListener('click', async ()=> {
  const horno = $('horno').value.trim();
  const fecha = $('fecha').value.trim();
  const turno = $('turno').value.trim();
  const horaInicio = $('horaInicio').value || horaAhoraHHMM();
  const horaFin = $('horaFin').value || addHoursToHHMM(horaInicio,10);
  const operarioInicio = $('operarioInicio').value.trim();

  if(!horno || !fecha || !turno){
    alert('‚ö†Ô∏è Debes seleccionar Horno, Fecha y Turno antes de iniciar.');
    return;
  }
  const snapshot = await db.ref('ciclosActivos').once('value');
  let duplicado = false;
  snapshot.forEach(ch=>{
    const meta = ch.val().meta || {};
    if(meta.horno===horno && meta.fecha===fecha && meta.turno===turno){
      duplicado = true;
    }
  });
  if(duplicado){
    alert('üö´ Ya existe un ciclo activo para este Horno, Fecha y Turno.');
    return;
  }

  const meta = { horno, fecha, turno, horaInicio, horaFin, operarioInicio };
  const newRef = await db.ref('ciclosActivos').push({ meta, lecturas: {} });
  await cargarActivosSelect();
  $('selActivos').value = newRef.key;
  attachLive(newRef.key);
  alert('‚úÖ Ciclo iniciado correctamente.');
});

/* Guardar lecturas */
$('btnGuardar').addEventListener('click', async ()=> {
  if(!currentCicloId){
    alert('‚ö†Ô∏è Primero inicia o selecciona un ciclo activo.');
    return;
  }
  const rows = Array.from(document.querySelectorAll('#tbody tr'));
  if(rows.length === 0){
    alert('No hay lecturas para guardar.');
    return;
  }
  const refLecturas = db.ref(`ciclosActivos/${currentCicloId}/lecturas`);
  const snap = await refLecturas.once('value');
  const existentes = {};
  snap.forEach(ch => {
    const val = ch.val();
    if(val && val.hora) existentes[val.hora] = ch.key;
  });

  const ops = [];
  for(const tr of rows){
    const hora = tr.querySelector('.hora').value;
    if(!hora) continue;
    const data = {
      hora,
      zona1: tr.querySelector('.zona1').value === '' ? null : parseFloat(tr.querySelector('.zona1').value),
      zona2: tr.querySelector('.zona2').value === '' ? null : parseFloat(tr.querySelector('.zona2').value),
      zona3: tr.querySelector('.zona3').value === '' ? null : parseFloat(tr.querySelector('.zona3').value),
      zona4: tr.querySelector('.zona4').value === '' ? null : parseFloat(tr.querySelector('.zona4').value),
      setPoint: tr.querySelector('.setPoint').value === '' ? null : parseFloat(tr.querySelector('.setPoint').value)
    };
    if(existentes[hora]) ops.push(refLecturas.child(existentes[hora]).set(data));
    else ops.push(refLecturas.push(data));
  }
  if(ops.length === 0){
    alert('No hay lecturas v√°lidas.');
    return;
  }
  await Promise.all(ops);
  alert('‚úÖ Lecturas guardadas o actualizadas correctamente.');
});

/* Finalizar ciclo */
$('btnFinalizar').addEventListener('click', async ()=> {
  if(!currentCicloId){
    alert('Selecciona o inicia primero un ciclo activo.');
    return;
  }
  const horaFinPrompt = prompt('Hora fin del ciclo (HH:MM):', $('horaFin').value || horaAhoraHHMM());
  if(horaFinPrompt === null) return;
  const operarioFin = prompt('Operario que finaliza:', '');
  if(operarioFin === null) return;
  const observaciones = prompt('Observaciones (opcional):', '') || '';

  const snap = await db.ref(`ciclosActivos/${currentCicloId}`).once('value');
  const node = snap.val();
  if(!node){ alert('No se encontr√≥ el ciclo activo.'); return; }

  node.meta = node.meta || {};
  node.meta.horaFin = horaFinPrompt;
  node.meta.operarioFin = operarioFin;
  node.meta.observaciones = observaciones;

  await db.ref('historicos').push(node);
  await db.ref(`ciclosActivos/${currentCicloId}`).remove();

  detachLive();
  $('tbody').innerHTML = `<tr>
    <td><input type="time" class="hora" value="${horaAhoraHHMM()}"></td>
    <td><input type="number" class="zona1" step="0.1"></td>
    <td><input type="number" class="zona2" step="0.1"></td>
    <td><input type="number" class="zona3" step="0.1"></td>
    <td><input type="number" class="zona4" step="0.1"></td>
    <td><input type="number" class="setPoint" step="0.1"></td>
    <td><button class="del" type="button" style="background:var(--accent);color:#000">‚úï</button></td>
  </tr>`;
  bindDeletes();

  $('horaInicio').value = horaAhoraHHMM();
  $('horaFin').value = addHoursToHHMM($('horaInicio').value,10);
  $('operarioInicio').value = '';
  await cargarActivosSelect();
  alert('‚úÖ Ciclo finalizado y movido a hist√≥ricos.');
});

/* ==================== INVENTARIO ==================== */
/* Turnos: T1 07:00‚Äì18:59, T2 19:00‚Äì06:59 con fecha base del T2 en el d√≠a anterior */
function turnoDetallado(){
  const ahora = new Date();
  const h = ahora.getHours();
  let turno = (h >= 7 && h < 19) ? "T1" : "T2";
  let fechaBase = new Date(ahora);
  if (turno === "T2" && h < 7) { fechaBase.setDate(fechaBase.getDate()-1); }
  return { turno, fechaISO: fechaBase.toISOString().slice(0,10) };
}
function obtenerTurnoActual(){ return turnoDetallado().turno; }
function fechaISO(){ return new Date().toISOString().slice(0,10); }
$('lblTurno').textContent = `${turnoDetallado().turno} (${turnoDetallado().fechaISO})`;

function getPlanta(machine){
  const m=(machine||"").trim().toUpperCase();
  if(["PRENSA 7-1","PRENSA 7-2","PRENSA 7-3","PRENSA 7-6","PRENSA 7-7","PRENSA 7-8"].includes(m)) return "A1";
  if(["PRENSA 7-4"].includes(m)) return "A2";
  if(["PRENSA 7-5","PRENSA 7-9","PRENSA 7-10"].includes(m)) return "A3";
  return "OTRA";
}
let basePendientes = [];
let maquinasSet = new Set();
let vista = "pendientes"; // "revisados" | "historial"
let cacheRevisadosTurno = {};  // {fecha_turno: {clave:payload,...}}
let vistaTablaPendientes = false;

/* seguridad: solo cargar si permitido */
function maybeLoadInventario(){
  if(!canUseAPI()){
    alert("üîí No tienes permisos para consumir la API. Pide a un admin que te asigne zona o rol.");
    return;
  }
  cargarPendientes();
}

function escucharRevisadosTurno(){
  const {turno, fechaISO: fBase} = turnoDetallado();
  const k = `${fBase}_${turno}`;
  dbInv.child("revisados").child(fBase).child(turno).on("value", snap=>{
    cacheRevisadosTurno[k] = snap.val() || {};
    render(); // refresca vistas y totales
  });
}
escucharRevisadosTurno();

async function fetchDep(fi,ff,dep){
  const resp=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({Fecha_inicial:fi,Fecha_final:ff,Departamento:dep})});
  const json=await resp.json(); let det=[]; if(json?.data) json.data.forEach(d=>{ if(Array.isArray(d.DetalleProduccion)) det=det.concat(d.DetalleProduccion); });
  return det;
}
async function cargarPendientes(){
  const fi="2025-01-01", ff=fechaISO();
  const [extrude,tmpin] = await Promise.all([fetchDep(fi,ff,"EXTRUDE"), fetchDep(fi,ff,"TMP-IN")]);

  const exMap={}, tmMap={};
  extrude.forEach(e=>{
    const k=`${e.sonum}-${e.soitemnum}`;
    if(!exMap[k]) exMap[k]={pzs:0,kg:0,ultima:null,mac:"-",Part:e.Part||"-",desc:e.descrip||"-",long:e.long||"-",prio:e.prio||"-",cli:e.cliente||"-"};
    exMap[k].pzs += toNum(e.PcProd);
    exMap[k].kg  += toNum(e.KgProd);
    if(!exMap[k].ultima || new Date(e.dt)>new Date(exMap[k].ultima)){
      exMap[k].ultima = e.dt;
      exMap[k].mac    = (e.MachineName||"-").trim();
    }
  });
  tmpin.forEach(t=>{
    const k=`${t.sonum}-${t.soitemnum}`;
    if(!tmMap[k]) tmMap[k]={pzs:0,kg:0};
    tmMap[k].pzs += toNum(t.PcProd);
    tmMap[k].kg  += toNum(t.KgProd);
  });

  basePendientes = [];
  maquinasSet.clear();

  Object.entries(exMap).forEach(([k,v])=>{
    const tm = tmMap[k] || {pzs:0,kg:0};
    const pzPend = (v.pzs||0) - (tm.pzs||0);
    const kgPend = (v.kg||0)  - (tm.kg||0);
    if(pzPend>0){
      const planta = getPlanta(v.mac);
      basePendientes.push({
        clave:k, piezasPend:pzPend, kgPend, ultimaMachine:v.mac, planta,
        ultimaFechaRaw:v.ultima, Part:v.Part, descrip:v.desc, long:v.long, prio:v.prio, cliente:v.cli
      });
      maquinasSet.add(v.mac);
    }
  });

  popularSelectMaquinas();
  $('ultimaInfoInv').textContent = "√öltima actualizaci√≥n: "+ new Date().toLocaleString("es-CO",{hour12:true});
  render();
}
function popularSelectMaquinas(){
  const sel = $('fMaquina'), cur = sel.value;
  sel.innerHTML = '<option value="">Todas</option>';
  Array.from(maquinasSet).sort((a,b)=>a.localeCompare(b,'es',{numeric:true})).forEach(m=>{
    const o=document.createElement("option"); o.value=m; o.textContent=m; sel.appendChild(o);
  });
  if([...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

function filtrarOrdenar(arr){
  const planta = $('fPlanta').value||"";
  const maq = $('fMaquina').value||"";
  const q = ($('fBuscar').value||"").toLowerCase();
  const ord = $('fOrden').value;

  let res = arr.filter(r=>{
    if(planta && r.planta!==planta) return false;
    if(maq && r.ultimaMachine!==maq) return false;
    if(q){
      const blob = `${r.clave} ${r.Part} ${r.descrip}`.toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });

  res.sort((a,b)=>{
    if(ord==="fecha_desc") return new Date(b.ultimaFechaRaw) - new Date(a.ultimaFechaRaw);
    if(ord==="fecha_asc")  return new Date(a.ultimaFechaRaw) - new Date(b.ultimaFechaRaw);
    if(ord==="kg_desc")    return toNum(b.kgPend) - toNum(a.kgPend);
    if(ord==="kg_asc")     return toNum(a.kgPend) - toNum(b.kgPend);
    if(ord==="machine")    return (a.ultimaMachine||"").localeCompare((b.ultimaMachine||""),"es",{numeric:true});
    if(ord==="part")       return (a.Part||"").localeCompare((b.Part||""),"es",{numeric:true});
    if(ord==="desc")       return (a.descrip||"").localeCompare((b.descrip||""),"es",{numeric:true});
    if(ord==="desc_rev")   return (b.descrip||"").localeCompare((a.descrip||""),"es",{numeric:true});
    return 0;
  });
  return res;
}

function actualizarTotales(){
  const {turno, fechaISO: fBase} = turnoDetallado();
  const revisadosTurno = cacheRevisadosTurno[`${fBase}_${turno}`] || {};

  const totalGeneral = basePendientes.reduce((s,r)=> s + toNum(r.kgPend), 0);

  const pendientesNoRevisados = basePendientes.filter(r => !revisadosTurno[r.clave]);
  const pendVisibles = filtrarOrdenar(pendientesNoRevisados);
  const totalPendVis = pendVisibles.reduce((s,r)=> s + toNum(r.kgPend), 0);

  const arrRev = Object.values(revisadosTurno).map(x=>x.record);
  const revVisibles = filtrarOrdenar(arrRev);
  const totalRevVis = revVisibles.reduce((s,r)=> s + toNum(r.kgPend), 0);

  const avance = totalGeneral>0 ? ((totalRevVis/totalGeneral)*100).toFixed(1) : "0.0";

  $('tTotalGeneral').textContent = Math.round(totalGeneral).toLocaleString();
  $('tPendientes').textContent   = Math.round(totalPendVis).toLocaleString();
  $('tRevisados').textContent    = Math.round(totalRevVis).toLocaleString();
  $('tAvance').textContent       = `${avance}%`;

  // KPI por m√°quina (en lo que se est√° viendo)
  const porMac = {};
  pendVisibles.forEach(r=>{
    const m=r.ultimaMachine||"-";
    porMac[m] = porMac[m] || {pend:0, rev:0};
    porMac[m].pend += toNum(r.kgPend);
  });
  revVisibles.forEach(r=>{
    const m=r.ultimaMachine||"-";
    porMac[m] = porMac[m] || {pend:0, rev:0};
    porMac[m].rev += toNum(r.kgPend);
  });

  const kpi = Object.entries(porMac)
    .sort((a,b)=>a[0].localeCompare(b[0],'es',{numeric:true}))
    .map(([m, v])=>{
      const tot = v.pend + v.rev;
      const p = tot>0 ? ((v.rev/tot)*100).toFixed(1) : "0.0";
      return `<span><b>${m}</b>: ${p}%</span>`;
    }).join(" ¬∑ ");

  $('kpiPorMac').innerHTML = kpi ? (`<b>Avance por m√°quina:</b> ${kpi}`) : "";
}

function renderPendientes(){
  const cont = $('listPend'); cont.innerHTML="";
  const {turno, fechaISO: fBase} = turnoDetallado();
  const revisadosTurno = cacheRevisadosTurno[`${fBase}_${turno}`] || {};
  const baseNoRevisados = basePendientes.filter(r => !revisadosTurno[r.clave]);
  const arr = filtrarOrdenar(baseNoRevisados);

  const frag=document.createDocumentFragment();
  arr.forEach(r=>{
    const el=document.createElement("div");
    el.className="inv-card";
    el.innerHTML = `
      <div class="inv-head">
        <div class="m">M√°quina: ${r.ultimaMachine}</div>
        <span class="badge">${r.planta}</span>
      </div>
      <div class="inv-meta">
        <div><b>SOITEM:</b> ${r.clave}</div>
        <div><b>Fecha:</b> ${fFecha(r.ultimaFechaRaw)}</div>
        <div><b>Part:</b> ${r.Part}</div>
        <div><b>Prioridad:</b> ${r.prio}</div>
        <div><b>Descripci√≥n:</b> ${r.descrip}</div>
        <div><b>Long:</b> ${r.long}</div>
        <div><b>Pzs Pend:</b> ${r.piezasPend}</div>
        <div><b>Kg Pend:</b> ${Math.round(r.kgPend||0)}</div>
      </div>
      <div class="inv-actions">
        <button class="btn-mini" data-act="comentario">üí¨ Comentario</button>
        <button class="btn-mini ok" data-act="ok">‚úÖ OK</button>
        <button class="btn-mini warn" data-act="detalle">üîé Detalle</button>
      </div>
    `;
    el.addEventListener("click",(ev)=>{
      const act=ev.target?.dataset?.act;
      if(act==="comentario"){
        const texto = prompt("Comentario:");
        if(texto === null) return;
        if(texto.trim().length === 0) return;
        guardarRevisado(r,{comentario:texto.trim(), ok:false});
      }
      if (act === "ok") {
        const confirmacion = confirm("¬øConfirmar revisi√≥n OK?");
        if (!confirmacion) return;
        ev.target.classList.add('confirmed');
        guardarRevisado(r, { comentario: null, ok: true });
      }
      if(act==="detalle") abrirModal(r, "pendiente");
    });
    frag.appendChild(el);
  });
  cont.appendChild(frag);
}

function renderRevisados(){
  const cont=$('listRevis'); cont.innerHTML="";
  const {turno, fechaISO: fBase} = turnoDetallado();
  const revMap = cacheRevisadosTurno[`${fBase}_${turno}`] || {};
  let arr = Object.values(revMap).map(x=>x);
  arr = arr.filter(it=>{
    const r=it.record;
    return filtrarOrdenar([r]).length>0;
  }).sort((a,b)=> new Date(b.fechaOK) - new Date(a.fechaOK));

  const frag=document.createDocumentFragment();
  arr.forEach(it=>{
    const r=it.record;
    const estado = it.comentario ? `üí¨ ${it.comentario}` : `‚úÖ OK`;
    const el=document.createElement("div");
    el.className="inv-card";
    el.innerHTML=`
      <div class="inv-head">
        <div class="m">M√°quina: ${r.ultimaMachine}</div>
        <span class="badge">${r.planta}</span>
      </div>
      <div class="inv-meta">
        <div><b>SOITEM:</b> ${r.clave}</div>
        <div><b>Marcado:</b> ${fFecha(it.fechaOK)}</div>
        <div><b>Part:</b> ${r.Part}</div>
        <div><b>Prioridad:</b> ${r.prio}</div>
        <div><b>Descripci√≥n:</b> ${r.descrip}</div>
        <div><b>Long:</b> ${r.long}</div>
        <div><b>Pzs Pend:</b> ${r.piezasPend}</div>
        <div><b>Kg Pend:</b> ${Math.round(r.kgPend||0)}</div>
        <div><b>Estado:</b> ${estado}</div>
      </div>
      <div class="inv-actions">
        <button class="btn-mini warn" data-act="editar">‚úèÔ∏è Editar</button>
        <button class="btn-mini rev" data-act="volver">‚Ü©Ô∏è Regresar</button>
        <button class="btn-mini" data-act="detalle">üîé Detalle</button>
      </div>
    `;
    el.addEventListener("click",(ev)=>{
      const act=ev.target?.dataset?.act;
      if(act==="editar") editarComentario(r.clave);
      if(act==="volver") regresarAPendientes(r.clave);
      if(act==="detalle") abrirModal(r, "revisado");
    });
    frag.appendChild(el);
  });
  cont.appendChild(frag);
}

async function renderHistorial(){
  const cont = $('listHist'); cont.innerHTML = "";
  const root = await dbInv.child("revisados").once("value");
  const registros = [];

  root.forEach(diaSnap=>{
    const fecha = diaSnap.key;
    diaSnap.forEach(turnoSnap=>{
      const turno = turnoSnap.key;
      turnoSnap.forEach(itemSnap=>{
        const v = itemSnap.val()||{};
        const r = v.record||{};
        registros.push({
          fechaPend: r.ultimaFechaRaw,
          fechaMarcado: v.fechaOK,
          turno,
          clave: r.clave,
          ultimaMachine: r.ultimaMachine,
          planta: r.planta,
          part: r.Part,
          descrip: r.descrip,
          long: r.long,
          prio: r.prio,
          piezasPend: r.piezasPend,
          kgPend: r.kgPend,
          comentario: v.comentario,
          ok: !!v.ok
        });
      });
    });
  });

  let arr = registros.filter(x=>{
    const obj = {
      planta:x.planta, ultimaMachine:x.ultimaMachine, clave:x.clave,
      Part:x.part, descrip:x.descrip, kgPend:x.kgPend, ultimaFechaRaw:x.fechaPend
    };
    return filtrarOrdenar([obj]).length>0;
  }).sort((a,b)=> new Date(b.fechaMarcado||b.fechaPend) - new Date(a.fechaMarcado||a.fechaPend));

  if(arr.length===0){
    cont.innerHTML = "<div class='inv-info'>Sin registros en el historial.</div>";
    return;
  }

  const frag = document.createDocumentFragment();
  arr.forEach(x=>{
    const el=document.createElement("div");
    el.className="inv-card";
    const estado = x.comentario ? `üí¨ ${x.comentario}` : (x.ok ? "‚úÖ OK" : "‚Äî");
    el.innerHTML = `
      <div class="inv-head">
        <div class="m">${x.clave}</div>
        <span class="badge">${x.planta||"-"}</span>
      </div>
      <div class="inv-meta">
        <div><b>Fecha pendiente:</b> ${fFecha(x.fechaPend)}</div>
        <div><b>Fecha revisado:</b> ${fFecha(x.fechaMarcado)}</div>
        <div><b>Turno:</b> ${x.turno}</div>
        <div><b>M√°quina:</b> ${x.ultimaMachine||"-"}</div>
        <div><b>Part:</b> ${x.part||"-"}</div>
        <div><b>Prioridad:</b> ${x.prio||"-"}</div>
        <div><b>Descripci√≥n:</b> ${x.descrip||"-"}</div>
        <div><b>Long:</b> ${x.long||"-"}</div>
        <div><b>Kg Pend (momento):</b> ${Math.round(x.kgPend||0)}</div>
        <div><b>Estado:</b> ${estado}</div>
      </div>`;
    el.addEventListener("click", ()=>{
      abrirModal({
        clave:x.clave, Part:x.part, descrip:x.descrip, prio:x.prio,
        long:x.long, piezasPend:x.piezasPend, kgPend:x.kgPend,
        ultimaMachine:x.ultimaMachine, planta:x.planta,
        ultimaFechaRaw:x.fechaPend
      }, "historial");
    });
    frag.appendChild(el);
  });
  cont.appendChild(frag);
}

function render(){
  if(vista==="pendientes"){
    $('listPend').classList.remove('hidden');
    $('listRevis').classList.add('hidden');
    $('listHist').classList.add('hidden');
    renderPendientes();
  } else if(vista==="revisados"){
    $('listPend').classList.add('hidden');
    $('listRevis').classList.remove('hidden');
    $('listHist').classList.add('hidden');
    renderRevisados();
  } else {
    $('listPend').classList.add('hidden');
    $('listRevis').classList.add('hidden');
    $('listHist').classList.remove('hidden');
    renderHistorial();
  }
  actualizarTotales();
}

function guardarRevisado(record,{comentario=null, ok=false}){
  const {turno, fechaISO: fBase} = turnoDetallado();
  const path = dbInv.child("revisados").child(fBase).child(turno).child(record.clave);
  const payload = {
    clave:record.clave,
    record,
    comentario: comentario && comentario.trim() ? comentario.trim() : null,
    ok,
    fechaOK: new Date().toISOString(),
    turno
  };
  path.set(payload);
}
function editarComentario(clave){
  const {turno, fechaISO: fBase} = turnoDetallado();
  const node = (cacheRevisadosTurno[`${fBase}_${turno}`]||{})[clave];
  if(!node) return;
  const nuevo = prompt("Editar comentario:", node.comentario || "");
  if(nuevo===null) return;
  dbInv.child("revisados").child(fBase).child(turno).child(clave)
    .update({ comentario: (nuevo.trim()? nuevo.trim(): null) });
}
function regresarAPendientes(clave){
  const {turno, fechaISO: fBase} = turnoDetallado();
  dbInv.child("revisados").child(fBase).child(turno).child(clave).remove();
}

/* Vista Tabla AGRUPADA */
$('btnVistaToggle').onclick = () => {
  if (vista !== "pendientes") {
    alert("üîπ Solo puedes usar la vista de tabla en Pendientes.");
    return;
  }
  vistaTablaPendientes = !vistaTablaPendientes;
  actualizarVistaPendientes();
  $('btnVistaToggle').textContent = vistaTablaPendientes ? "üÉè Vista Cards" : "üìã Vista Tabla";
};
$('agrupacionTabla').onchange = renderTablaAgrupada;
$('btnRecargarTabla').onclick = renderTablaAgrupada;

function actualizarVistaPendientes() {
  $('listPend').classList.add("hidden");
  $('viewTabla').classList.add("hidden");
  $('listRevis').classList.add("hidden");
  $('listHist').classList.add("hidden");

  if (vista === "pendientes") {
    if (vistaTablaPendientes) {
      $('viewTabla').classList.remove("hidden");
      renderTablaAgrupada();
    } else {
      $('listPend').classList.remove("hidden");
      renderPendientes();
    }
  } else if (vista === "revisados") {
    $('listRevis').classList.remove("hidden");
    renderRevisados();
  } else if (vista === "historial") {
    $('listHist').classList.remove("hidden");
    renderHistorial();
  }
  actualizarTotales();
}
["fPlanta","fMaquina","fOrden"].forEach(id => $(id).addEventListener("change", ()=>{ vistaTablaPendientes? renderTablaAgrupada(): render(); }));
$('fBuscar').addEventListener("input", ()=>{ vistaTablaPendientes? renderTablaAgrupada(): render(); });

function renderTablaAgrupada() {
  const { turno, fechaISO: fBase } = turnoDetallado();
  const revisadosTurno = cacheRevisadosTurno[`${fBase}_${turno}`] || {};
  const baseNoRevisados = basePendientes.filter(r => !revisadosTurno[r.clave]);
  const arr = filtrarOrdenar(baseNoRevisados);

  const agr = $('agrupacionTabla').value;
  const grupos = {};
  arr.forEach(r => {
    const key = agr === 'part' ? r.Part : r.descrip;
    if (!grupos[key]) grupos[key] = [];
    grupos[key].push(r);
  });

  const cont = $('tablaAgrupada');
  cont.innerHTML = '';
  Object.entries(grupos).forEach(([key, items]) => {
    const groupDiv = document.createElement('div');
    groupDiv.className = 'grupoTabla';

    const titulo = document.createElement('h3');
    titulo.textContent = key;
    titulo.className = 'titulo-grupo';
    groupDiv.appendChild(titulo);

    const colExtra = agr === 'part' ? 'Descripci√≥n' : 'Part';

    const table = document.createElement('div');
    table.className = 'tabla-scroll';
    table.innerHTML = `
      <table class="tabla-grupo">
        <thead>
          <tr>
            <th>SOITEM</th>
            <th>M√°quina</th>
            <th>Pzs Pend</th>
            <th>Kg Pend</th>
            <th>Long</th>
            <th>${colExtra}</th>
            <th>Prioridad</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>`;
    const tbody = table.querySelector('tbody');

    items.forEach(r => {
      const tr = document.createElement('tr');
      const extraValue = agr === 'part' ? r.descrip : r.Part;

      tr.innerHTML = `
        <td>${r.clave}</td>
        <td>${r.ultimaMachine}</td>
        <td>${r.piezasPend}</td>
        <td>${Math.round(r.kgPend)}</td>
        <td>${r.long}</td>
        <td>${extraValue}</td>
        <td>${r.prio}</td>
        <td class="acciones-cell">
          <button class="btn-mini ok" data-act="ok">‚úÖ</button>
          <button class="btn-mini warn" data-act="coment">üí¨</button>
        </td>`;

      const btnOk = tr.querySelector('[data-act="ok"]');
      const btnCom = tr.querySelector('[data-act="coment"]');

      btnOk.onclick = (ev) => {
        const confirmar = confirm("¬øConfirmar revisi√≥n OK?");
        if (!confirmar) return;
        ev.target.classList.add('confirmed');
        guardarRevisado(r, { ok: true });
        tr.style.opacity = '0.5';
      };
      btnCom.onclick = () => { abrirModal(r, 'pendiente'); };

      tbody.appendChild(tr);
    });

    groupDiv.appendChild(table);
    cont.appendChild(groupDiv);
  });
}

/* ===== Modal Inventario ===== */
let modalData = null;
function abrirModal(record, origen){
  modalData = {record, origen};
  $('mdTitulo').textContent = `SOITEM ${record.clave}`;
  $('mdSoitem').textContent = record.clave;
  $('mdPart').textContent   = record.Part || "-";
  $('mdDesc').textContent   = record.descrip || "-";
  $('mdPrio').textContent   = record.prio || "-";
  $('mdLong').textContent   = record.long || "-";
  $('mdPzs').textContent    = record.piezasPend ?? "-";
  $('mdKg').textContent     = Math.round(record.kgPend||0);
  $('mdMac').textContent    = record.ultimaMachine || "-";
  $('mdPlanta').textContent = record.planta || "-";
  $('mdFec').textContent    = fFecha(record.ultimaFechaRaw);
  $('mdCmt').value          = "";

  cargarTrazabilidad(record.clave).then(html=>{
    $('mdTrace').innerHTML = html;
  });

  $('btnOk').style.display        = (origen==="pendiente") ? "inline-block" : "none";
  $('btnRegresar').style.display  = (origen==="revisado")  ? "inline-block" : "none";
  $('modalInv').style.display = "flex";
}
function cerrarModal(){ $('modalInv').style.display = "none"; modalData=null; }
$('btnCloseInv').onclick = cerrarModal;

$('btnGuardarCmt').onclick = ()=>{
  if(!modalData) return;
  const cmt = $('mdCmt').value || "";
  if(modalData.origen==="pendiente"){
    if(cmt.trim().length===0) return;
    guardarRevisado(modalData.record, {comentario:cmt.trim(), ok:false});
  }else if(modalData.origen==="revisado"){
    const {turno, fechaISO: fBase} = turnoDetallado();
    const clave = modalData.record.clave;
    dbInv.child("revisados").child(fBase).child(turno).child(clave)
      .update({comentario: cmt.trim()? cmt.trim() : null});
  }
  $('mdCmt').value="";
};
$('btnOk').onclick = ()=>{
  if(!modalData) return;
  guardarRevisado(modalData.record, {comentario: ($('mdCmt').value||"").trim()||null, ok:true});
  cerrarModal();
};
$('btnRegresar').onclick = ()=>{
  if(!modalData) return;
  regresarAPendientes(modalData.record.clave);
  cerrarModal();
};

async function cargarTrazabilidad(clave){
  const root = await dbInv.child("revisados").once("value");
  const html = [];
  root.forEach(diaSnap=>{
    const fecha = diaSnap.key;
    diaSnap.forEach(turnoSnap=>{
      const turno = turnoSnap.key;
      const node = turnoSnap.child(clave);
      if(node.exists()){
        const v = node.val();
        html.push(`<div>üìå <b>${fecha}</b> ¬∑ <b>${turno}</b> ¬∑ ${fFecha(v.fechaOK)} ¬∑ ${v.comentario?('üí¨ '+v.comentario):'‚úÖ OK'}</div>`);
      }
    });
  });
  return html.length ? html.join("") : "(sin registros)";
}

/* Eventos Inventario */
$('btnActualizarInv').onclick = async ()=>{
  if(!canUseAPI()){ alert('üîí No tienes permisos para consumir la API.'); return; }
  const b=$('btnActualizarInv'); b.disabled=true; const old=b.textContent; b.textContent="Cargando...";
  try{ await cargarPendientes(); } catch(e){ alert("Error: "+(e.message||e)); }
  b.disabled=false; b.textContent=old;
};
['fPlanta','fMaquina','fOrden'].forEach(id=> $(id).addEventListener('change', ()=>{ vistaTablaPendientes? renderTablaAgrupada(): render(); }));
$('fBuscar').addEventListener('input', ()=>{ vistaTablaPendientes? renderTablaAgrupada(): render(); });

/* ==================== PLANOS (con seguridad y Excel CSV + fallback) ==================== */
let planosCache = []; // {codigo,descripcion,cliente,zona,url,coords?}
$('btnCargarPlanos').onclick = cargarPlanos;

async function cargarPlanos(){
  if(!currentUser){ alert('Inicia sesi√≥n para ver planos.'); return; }
  const grid = $('plGrid'); grid.innerHTML = '';
  let origen = '';

  try{
    if(PLANOS_SHEET_CSV_URL){
      const res = await fetch(PLANOS_SHEET_CSV_URL);
      const txt = await res.text();
      planosCache = parseCSV(txt);
      origen = 'Excel publicado (CSV)';
    } else {
      const snap = await dbPlanos.once('value');
      const arr = [];
      snap.forEach(ch=>{ arr.push(ch.val()); });
      planosCache = arr;
      origen = 'Firebase (fallback)';
    }
  } catch(e) {
    const snap = await dbPlanos.once('value');
    const arr = [];
    snap.forEach(ch=>{ arr.push(ch.val()); });
    planosCache = arr;
    origen = 'Firebase (fallback por error CSV)';
  }
  $('plInfo').textContent = "Origen: " + origen;

  renderPlanos();
}
function parseCSV(txt){
  // CSV simple con cabecera: codigo,descripcion,cliente,zona,url,coords
  const lines = txt.split(/\r?\n/).filter(l=>l.trim().length);
  if(lines.length<=1) return [];
  const head = lines[0].split(',').map(s=>s.trim().toLowerCase());
  const idx = key => head.indexOf(key);
  const out=[];
  for(let i=1;i<lines.length;i++){
    const cols = splitCSVLine(lines[i]);
    out.push({
      codigo: cols[idx('codigo')] || '',
      descripcion: cols[idx('descripcion')] || '',
      cliente: cols[idx('cliente')] || '',
      zona: cols[idx('zona')] || '',
      url: cols[idx('url')] || '',
      coords: safeJSON(cols[idx('coords')] || '')
    });
  }
  return out;
}
function splitCSVLine(line){
  // soporta comillas
  const result=[]; let cur=''; let quote=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"' ){ quote = !quote; continue; }
    if(c===',' && !quote){ result.push(cur); cur=''; continue; }
    cur+=c;
  }
  result.push(cur);
  return result.map(s=>s.trim());
}
function safeJSON(str){ try{ return JSON.parse(str); }catch(e){ return null; } }

$('plBuscar').addEventListener('input', renderPlanos);
$('plZona').addEventListener('change', renderPlanos);

function renderPlanos(){
  const grid = $('plGrid'); grid.innerHTML='';
  const q = ($('plBuscar').value||'').toLowerCase();
  const z = $('plZona').value||'';

  const list = planosCache.filter(p=>{
    if(q){
      const blob = `${p.codigo} ${p.descripcion} ${p.cliente}`.toLowerCase();
      if(!blob.includes(q)) return false;
    }
    if(z && p.zona && p.zona.toUpperCase()!==z.toUpperCase()) return false;
    // seguridad por plano
    return canViewPlanos(p);
  });

  if(list.length===0){
    grid.innerHTML = `<div class="inv-info">No hay resultados (verifica filtros/permiso de zona).</div>`;
    return;
  }

  const frag = document.createDocumentFragment();
  list.forEach(p=>{
    const el=document.createElement('div');
    el.className='pl-card';
    el.innerHTML=`
      <div class="pl-title">${p.codigo || '(sin c√≥digo)'}</div>
      <div class="pl-meta">
        <div><b>Zona:</b> ${p.zona||'-'}</div>
        <div><b>Cliente:</b> ${p.cliente||'-'}</div>
        <div style="grid-column:1 / -1"><b>Descripci√≥n:</b> ${p.descripcion||'-'}</div>
      </div>
      <div class="pl-actions">
        <button class="btn-mini ok" data-act="ver">üëÅÔ∏è Ver</button>
        ${p.url ? `<a class="btn-mini" href="${p.url}" target="_blank" rel="noopener">‚ÜóÔ∏è Abrir</a>` : ''}
      </div>`;
    el.addEventListener('click',(ev)=>{
      if(ev.target?.dataset?.act==='ver'){
        abrirPlanoModal(p);
      }
    });
    frag.appendChild(el);
  });
  grid.appendChild(frag);
}

function abrirPlanoModal(p){
  if(!canViewPlanos(p)){
    alert('üîí No tienes permiso para ver este plano (zona restringida).');
    return;
  }
  $('plTitulo').textContent = `${p.codigo} ‚Äî ${p.descripcion||''}`;
  $('plChips').innerHTML = `${p.zona? `<span class="pill">Zona ${p.zona}</span>`:''}${p.cliente? `<span class="pill">${p.cliente}</span>`:''}`;
  const img = $('plImg');
  img.src = p.url || '';
  img.alt = p.descripcion || p.codigo || 'Plano';

  // Marcas (coords) si existen (opcional); se podr√≠a dibujar sobre canvas, por simplicidad omitimos overlay gr√°fico.
  $('modalPlano').style.display='flex';
}
$('btnClosePlano').onclick = ()=> $('modalPlano').style.display='none';

/* ==================== ADMIN ==================== */
function reqAdmin(){
  if(!currentUser || !(currentRole==='admin' || currentRole==='superadmin')){
    alert('üîí Requiere admin/superadmin.');
    return false;
  }
  return true;
}
$('btnAsignar').onclick = async ()=>{
  if(!reqAdmin()) return;
  const email = ($('adEmail').value||'').trim().toLowerCase();
  const role = $('adRol').value;
  const zone = $('adZona').value || '';
  if(!email){ alert('Correo requerido'); return; }

  // si el usuario ya existe (uid), actualizamos /roles; si no, guardamos en /preUsers
  const uidSnap = await dbUsers.child(escapeEmail(email)).once('value');
  if(uidSnap.exists()){
    const uid = uidSnap.val().uid;
    await dbRoles.child(uid).set({email, role, zone});
  } else {
    await db.ref('preUsers').child(escapeEmail(email)).set({email,role,zone});
  }
  alert('‚úÖ Asignado/Actualizado.');
  loadUsersTableIfAdmin();
};
$('btnEliminar').onclick = async ()=>{
  if(!reqAdmin()) return;
  const email = ($('adEmail').value||'').trim().toLowerCase();
  if(!email){ alert('Correo requerido'); return; }

  const uidSnap = await dbUsers.child(escapeEmail(email)).once('value');
  if(uidSnap.exists()){
    const uid = uidSnap.val().uid;
    await dbRoles.child(uid).remove();
  }
  await db.ref('preUsers').child(escapeEmail(email)).remove();
  alert('üóëÔ∏è Eliminado (roles/preregistro).');
  loadUsersTableIfAdmin();
};

async function loadUsersTableIfAdmin(){
  if(!currentUser || !(currentRole==='admin' || currentRole==='superadmin')){ $('tbUsers').innerHTML=''; return; }
  const tbody = $('tbUsers'); tbody.innerHTML='';
  const snap = await dbRoles.once('value');
  const frag=document.createDocumentFragment();
  snap.forEach(ch=>{
    const v = ch.val()||{};
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${v.email||'-'}</td><td>${v.role||'user'}</td><td>${v.zone||''}</td><td>${ch.key}</td>`;
    tr.onclick = ()=>{
      $('adEmail').value = v.email||'';
      $('adRol').value = v.role||'user';
      $('adZona').value = v.zone||'';
    };
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);
}

/* ==================== INIT ==================== */
/* Tabs principales inventario */
$('tabPend').onclick = () => { vista = "pendientes"; ["tabPend","tabRevis","tabHist"].forEach(id=>$(id).classList.remove("active")); $("tabPend").classList.add("active"); actualizarVistaPendientes(); };
$('tabRevis').onclick = () => { vista = "revisados"; ["tabPend","tabRevis","tabHist"].forEach(id=>$(id).classList.remove("active")); $("tabRevis").classList.add("active"); actualizarVistaPendientes(); };
$('tabHist').onclick = () => { vista = "historial"; ["tabPend","tabRevis","tabHist"].forEach(id=>$(id).classList.remove("active")); $("tabHist").classList.add("active"); actualizarVistaPendientes(); };

/* Cargar pendientes solo si seguridad lo permite (cuando entras a la vista) */
/* showView('temperaturas') es por defecto */

/* ====== Fallback de datos de planos (ejemplo) ======
  Puedes borrar este bloque de set() tras cargar tus verdaderos planos,
  se ejecuta una sola vez si /planos est√° vac√≠o. */
(async function seedPlanosIfEmpty(){
  const s = await dbPlanos.limitToFirst(1).once('value');
  if(!s.exists()){
    const sample=[
      {codigo:"PL-EX-001", descripcion:"Ventana piso 4 lateral", cliente:"Cliente A", zona:"A1", url:"https://upload.wikimedia.org/wikipedia/commons/thumb/3/3f/Fronalpstock_big.jpg/640px-Fronalpstock_big.jpg"},
      {codigo:"PL-EX-002", descripcion:"Puerta acceso principal", cliente:"Cliente B", zona:"A2", url:"https://upload.wikimedia.org/wikipedia/commons/thumb/b/b6/Image_created_with_a_mobile_phone.png/640px-Image_created_with_a_mobile_phone.png"},
      {codigo:"PL-EX-003", descripcion:"Fachada m√≥dulo C", cliente:"Cliente C", zona:"A3", url:"https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Alaskan_Malamute.jpg/640px-Alaskan_Malamute.jpg"}
    ];
    const ops = sample.map(x=> dbPlanos.push(x));
    await Promise.all(ops);
  }
})();
</script>
</body>
</html>