<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Registro de Temperaturas + Inventario + Planos</title>
<meta name="theme-color" content="#121212"/>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase compat v9 -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --bg:#121212; --panel:#1b1b1b; --panel-2:#151515; --soft:#242424; --border:#2c2c2c;
  --accent:#00e5ff; --accent2:#ffb300; --ok:#10b981; --warn:#f59e0b; --muted:#9aa9b1;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,Arial,Helvetica,sans-serif}
.wrap{max-width:1120px;margin:12px auto;padding:12px}

/* Header */
.header-bar{display:flex;align-items:center;gap:10px;justify-content:center;position:relative;margin-bottom:10px}
.header-title{color:var(--accent);font-weight:800;font-size:22px;text-align:center}
.hamb{position:absolute;left:0;top:50%;transform:translateY(-50%);background:transparent;border:1px solid var(--soft);color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
.hamb:active{filter:brightness(.9)}
.btn{border:1px solid var(--soft);background:#0f0f0f;border-radius:8px;padding:8px 12px;color:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#000;border-color:var(--accent);font-weight:800}
.btn.danger{background:var(--accent2);color:#000;border-color:var(--accent2);font-weight:800}

/* Drawer */
.drawer-mask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:900}
.drawer{position:fixed;right:0;top:0;height:100%;width:320px;max-width:92vw;background:#0f0f0f;border-left:1px solid var(--soft);transform:translateX(100%);transition:transform .25s ease;z-index:1000;display:flex;flex-direction:column}
.drawer.open{transform:translateX(0)}
.drawer .head{padding:14px;border-bottom:1px solid var(--soft);font-weight:800;display:flex;justify-content:space-between;align-items:center}
.drawer .head button{background:transparent;color:#fff;border:1px solid var(--soft);border-radius:8px;padding:6px 10px}
.drawer .body{padding:10px;display:flex;flex-direction:column;gap:10px}
.drawer .opt{background:#121212;border:1px solid var(--soft);padding:12px;border-radius:10px;cursor:pointer}
.drawer .opt small{color:#9aa9b1}

/* Cards */
.card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,.35)}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
label{display:block;margin:6px 0 4px;font-weight:700;color:#ddd}
input,select,textarea{width:100%;background:#fff;color:#000;border:1px solid #ccc;border-radius:6px;padding:8px}

/* Tabla simple */
.table-wrap{overflow:auto;border-radius:8px;border:1px solid var(--soft)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--border);text-align:center}
th{background:#171717;color:var(--accent)}
canvas{width:100%!important;height:360px!important;background:#151515;border-radius:6px}

/* Planos modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:1200}
.win{background:#1a1a1a;border:1px solid #333;border-radius:14px;max-width:95vw;width:95vw;max-height:92vh;display:flex;flex-direction:column;overflow:hidden;color:#fff}
.win .head{padding:10px;border-bottom:1px solid var(--soft);display:flex;justify-content:space-between;align-items:center}
.win .body{padding:0;overflow:auto;background:#000}
.close{border:1px solid var(--soft);background:#151515;border-radius:8px;padding:6px 10px;color:#fff}
#viewerPlano{width:95vw;height:80vh;border:0}

/* GPS */
#panelGPS{position:fixed;bottom:64px;right:10px;background:#111;padding:10px 14px;border:1px solid var(--accent);border-radius:10px;color:#0ff;font-size:12px;font-family:monospace;z-index:9999;display:none}
#btnGPS{position:fixed;bottom:10px;right:10px;background:var(--accent);color:#000;border:none;padding:6px 10px;border-radius:8px;font-weight:bold;cursor:pointer;z-index:10000}

/* Admin */
.admin-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.badge{display:inline-block;padding:3px 8px;border:1px solid var(--soft);border-radius:999px;background:#0f0f0f;color:#cfeaf0;font-size:12px}

/* Responsive */
@media (max-width:900px){ .grid4{grid-template-columns:repeat(2,1fr)} canvas{height:320px!important} }
@media (max-width:520px){ .grid4{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="header-bar">
    <button class="hamb" id="btnMenu">☰</button>
    <div class="header-title" id="topTitle">Registro de Temperaturas</div>
    <button class="btn" id="btnLogin" style="position:absolute;right:0;top:50%;transform:translateY(-50%)">Iniciar sesión</button>
  </div>

  <!-- ===== VISTA: TEMPERATURAS ===== -->
  <div id="view-temperaturas">
    <div class="card">
      <div class="grid4">
        <div>
          <label>Horno</label>
          <select id="horno">
            <option value="">-- Selecciona --</option>
            <option>Horno 5</option><option>Horno 7-3</option><option>Horno 9-1</option>
            <option>Horno 9-2</option><option>Horno Italiano</option><option>Horno 7-4</option>
            <option>Horno 7-5</option><option>Horno 9-3</option><option>Horno 10</option>
          </select>
        </div>
        <div>
          <label>Fecha</label>
          <input type="date" id="fecha">
        </div>
        <div>
          <label>Turno</label>
          <select id="turno"><option value="">-- Selecciona --</option><option value="T1">T1</option><option value="T2">T2</option></select>
        </div>
        <div>
          <label>Ciclos activos</label>
          <select id="selActivos"><option value="">-- Ninguno --</option></select>
        </div>
      </div>

      <div class="grid4" style="margin-top:12px">
        <div>
          <label>Hora inicio</label>
          <input type="time" id="horaInicio">
        </div>
        <div>
          <label>Hora fin (auto +10h)</label>
          <input type="time" id="horaFin">
        </div>
        <div>
          <label>Operario (inicia)</label>
          <input type="text" id="operarioInicio" placeholder="nombre">
        </div>
        <div style="display:flex;align-items:end;gap:8px">
          <button id="btnNuevo" class="btn primary">Iniciar ciclo</button>
          <button id="btnRecargar" class="btn">Recargar ciclos</button>
        </div>
      </div>
      <div class="muted" style="color:var(--muted);margin-top:6px">Si existe un ciclo activo (mismo Horno/Fecha/Turno) aparecerá arriba.</div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;color:var(--accent)">Agregar lecturas por hora</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Hora</th><th>Zona 1</th><th>Zona 2</th><th>Zona 3</th><th>Zona 4</th><th>SetPoint</th><th>Quitar</th></tr>
          </thead>
          <tbody id="tbody">
            <tr>
              <td><input type="time" class="hora"></td>
              <td><input type="number" class="zona1" step="0.1"></td>
              <td><input type="number" class="zona2" step="0.1"></td>
              <td><input type="number" class="zona3" step="0.1"></td>
              <td><input type="number" class="zona4" step="0.1"></td>
              <td><input type="number" class="setPoint" step="0.1"></td>
              <td><button class="btn" data-del>✕</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button id="btnAgregarFila" class="btn primary">Agregar lectura</button>
        <button id="btnGuardar" class="btn primary">Guardar lecturas</button>
        <button id="btnFinalizar" class="btn danger">Finalizar ciclo</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;color:var(--accent)">Gráfica del ciclo seleccionado (en tiempo real)</h3>
      <canvas id="chart"></canvas>
      <div id="cabecera" style="color:#9aa9b1;margin-top:8px"></div>
    </div>
  </div>

  <!-- ===== VISTA: INVENTARIO ===== -->
  <div id="view-inventario" style="display:none">
    <div class="card" style="background:var(--panel-2)">
      <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
        <span class="badge">Turno: <b id="lblTurno">-</b></span>
        <label style="margin:0 0 0 8px">Planta</label>
        <select id="fPlanta"><option value="">Todas</option><option>A1</option><option>A2</option><option>A3</option><option>OTRA</option></select>
        <label style="margin:0 0 0 8px">Máquina</label>
        <select id="fMaquina"><option value="">Todas</option></select>
        <label style="margin:0 0 0 8px">Buscar</label>
        <input id="fBuscar" placeholder="soitem, part, desc..." style="max-width:220px"/>
        <label style="margin:0 0 0 8px">Ordenar</label>
        <select id="fOrden">
          <option value="fecha_desc">Fecha reciente</option>
          <option value="fecha_asc">Fecha antigua</option>
          <option value="machine">Máquina</option>
          <option value="part">Part</option>
          <option value="kg_desc">Kg ↓</option>
          <option value="kg_asc">Kg ↑</option>
          <option value="desc">Descripción (A-Z)</option>
          <option value="desc_rev">Descripción (Z-A)</option>
        </select>
        <button id="btnActualizarInv" class="btn">Actualizar</button>
        <button id="btnVistaToggle" class="btn">📋 Vista Tabla</button>
        <span id="ultimaInfoInv" class="badge">Última actualización: -</span>
      </div>
      <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
        <span class="badge"><b>Total:</b> <span id="tTotalGeneral">0</span> Kg</span>
        <span class="badge"><b>Pendientes:</b> <span id="tPendientes">0</span> Kg</span>
        <span class="badge"><b>Revisados:</b> <span id="tRevisados">0</span> Kg</span>
        <span class="badge"><b>Avance:</b> <span id="tAvance">0%</span></span>
      </div>
      <div id="kpiPorMac" style="margin-top:6px;color:#9aa9b1;font-size:12px"></div>
    </div>

    <!-- Contenedores (Cards/Tabla) -->
    <div id="listPend" class="card">Cargando…</div>
    <div id="listRevis" class="card" style="display:none"></div>
    <div id="listHist"  class="card" style="display:none"></div>

    <!-- Tabla agrupada -->
    <div id="viewTabla" class="card" style="display:none">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <label style="margin:0">Agrupar por</label>
        <select id="agrupacionTabla"><option value="part">Part</option><option value="desc">Descripción</option></select>
        <button id="btnRecargarTabla" class="btn primary">🔄 Recargar</button>
      </div>
      <div id="tablaAgrupada" class="table-wrap"></div>
    </div>
  </div>

  <!-- ===== VISTA: PLANOS ===== -->
  <div id="view-planos" style="display:none">
    <div class="card" style="background:var(--panel-2)">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <label style="margin:0">Buscar plano</label>
        <input id="buscarPlano" placeholder="Nombre del plano..." style="max-width:260px"/>
        <button id="btnRecargarPlanos" class="btn primary">🔄 Recargar</button>
      </div>
      <div class="table-wrap" style="max-height:70vh;overflow:auto;margin-top:10px">
        <table id="tablaPlanos">
          <thead>
            <tr>
              <th style="text-align:center">Nombre</th>
              <th style="text-align:center">Abrir</th>
            </tr>
          </thead>
          <tbody id="tbodyPlanos"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== VISTA: ADMIN ===== -->
  <div id="view-admin" style="display:none">
    <div class="card">
      <h3 style="margin:0 0 10px;color:var(--accent)">Panel de administración</h3>
      <div class="admin-grid">
        <!-- Usuarios -->
        <div class="card" style="background:var(--panel-2)">
          <h4>Usuarios</h4>
          <div style="display:grid;gap:8px">
            <input id="admCorreo" placeholder="correo@dominio.com"/>
            <select id="admRol">
              <option value="user">user</option>
              <option value="admin">admin</option>
              <option value="superadmin">superadmin</option>
            </select>
            <label><input type="checkbox" id="admAutorizado"> Usuario autorizado</label>
            <label><input type="checkbox" id="admAPI"> Permiso API</label>
            <label><input type="checkbox" id="admPlanos"> Permiso Planos</label>
            <select id="admZona"><option value="">Seleccione zona…</option></select>
            <input id="admRango" type="number" step="0.1" placeholder="rango_km (ej: 2)"/>
            <button id="btnGuardarUsuario" class="btn primary">Guardar/Actualizar usuario</button>
          </div>
          <div style="margin-top:10px">
            <h5>Lista</h5>
            <div id="listaUsuarios" style="font-size:14px;color:#ddd"></div>
          </div>
        </div>

        <!-- Zonas -->
        <div class="card" style="background:var(--panel-2)">
          <h4>Zonas</h4>
          <div style="display:grid;gap:8px">
            <input id="admNombreZona" placeholder="Nombre zona (clave)"/>
            <input id="admLat" type="number" step="0.00001" placeholder="Latitud"/>
            <input id="admLng" type="number" step="0.00001" placeholder="Longitud"/>
            <input id="admRadio" type="number" step="0.1" placeholder="Radio (km)"/>
            <button id="btnGuardarZona" class="btn">Guardar/Actualizar zona</button>
          </div>
          <div style="margin-top:10px">
            <h5>Lista</h5>
            <div id="listaZonas" style="font-size:14px;color:#ddd"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div><!-- /wrap -->

<!-- Drawer -->
<div class="drawer" id="drawer">
  <div class="head">
    <span>Menú principal</span>
    <button id="btnCloseDrawer">✕</button>
  </div>
  <div class="body">
    <div class="opt" data-target="temperaturas"><b>Registro de Temperaturas</b><br><small>Lecturas por zona y ciclo</small></div>
    <div class="opt" data-target="inventario"><b>Inventario Por Templar</b><br><small>Gestión y trazabilidad</small></div>
    <div class="opt" data-target="planos"><b>Consulta de Planos</b><br><small>Visualización segura</small></div>
    <div class="opt" data-target="admin" id="optAdmin" style="display:none"><b>Administración</b><br><small>Usuarios y Zonas</small></div>
    <div class="opt" id="optCambiar"><b>👤 Cambiar usuario</b><br><small>Volver a iniciar con otro correo</small></div>
  </div>
</div>
<div class="drawer-mask" id="drawerMask"></div>

<!-- Modal planos -->
<div class="modal" id="modalPlanos">
  <div class="win">
    <div class="head">
      <b id="mdPlanoTitulo">Plano</b>
      <button class="close" id="btnCerrarPlano">Cerrar</button>
    </div>
    <div class="body">
      <iframe id="viewerPlano" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>
  </div>
</div>

<!-- Panel GPS -->
<div id="panelGPS"></div>
<button id="btnGPS">🛰️ GPS</button>

<script>
"use strict";

/* ==================== Firebase ==================== */
const firebaseConfig = {
  apiKey: "AIzaSyAB4UlwaVJzc4U4VbmddLf4mejKAOvTufw",
  authDomain: "hornosapp-60887.firebaseapp.com",
  databaseURL: "https://hornosapp-60887-default-rtdb.firebaseio.com",
  projectId: "hornosapp-60887"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ==================== Helpers ==================== */
const $ = id => document.getElementById(id);
const pad2 = n => String(n).padStart(2,'0');
const hoyISO = () => new Date().toISOString().slice(0,10);
function horaAhora(){ const d=new Date(); return pad2(d.getHours())+':'+pad2(d.getMinutes()); }
function addHours(hhmm, plus=10){ const [h,m]=hhmm.split(':').map(Number); const d=new Date(); d.setHours(h||0,m||0,0,0); d.setHours(d.getHours()+plus); return pad2(d.getHours())+':'+pad2(d.getMinutes()); }
function toAMPM(hhmm){ const [h,m]=hhmm.split(':').map(Number); const H=h%12||12; return `${H}:${pad2(m)} ${h>=12?'PM':'AM'}`; }
function correoToKey(c){ return (c||'').toLowerCase().replace(/\./g,'_').replace(/@/g,'_'); }

/* ==================== Estado sesión/seguridad ==================== */
let session = {
  correo: localStorage.getItem("correo_autorizado") || "",
  rol: "user",
  autorizado: false,
  permiso_api: false,
  permiso_planos: false,
  zona: "",
  rango_km: 2
};
let zonasCache = {};           // { nombre: {lat,lng,radio_km} }
let accesoPermitido = false;   // habilita Inventario/Planos si pasa checks
const TOLERANCIA_KM = 0.5;     // tolerancia extra

/* ==================== Login simple ==================== */
async function ensureLogin(promptIfNeeded=true){
  if(!session.correo && promptIfNeeded){
    const c = prompt("Introduce tu correo corporativo (ej: gary.maldonado@tecnoglass.com):");
    if(!c){ alert("⚠️ No se puede continuar sin correo."); return false; }
    session.correo = c.trim();
    localStorage.setItem("correo_autorizado", session.correo);
  }
  if(!session.correo) return false;
  await cargarPerfilYPermisos();
  aplicarVisibilidadMenus();
  return true;
}

async function cargarPerfilYPermisos(){
  // Zonas
  const zSnap = await db.ref("seguridad/zonas").once("value");
  zonasCache = zSnap.val() || {};
  // Usuario
  const key = correoToKey(session.correo);
  const uSnap = await db.ref("seguridad/usuarios/"+key).once("value");
  const u = uSnap.val();
  if(!u){
    // si no existe, registro mínimo (autorizado false)
    await db.ref("seguridad/usuarios/"+key).set({
      autorizado:false, permiso_api:false, permiso_planos:false, rol:"user", zona:"Libre", rango_km:2
    });
    Object.assign(session,{autorizado:false,permiso_api:false,permiso_planos:false,rol:"user",zona:"Libre",rango_km:2});
  }else{
    Object.assign(session,{
      rol: u.rol || "user",
      autorizado: !!u.autorizado,
      permiso_api: !!u.permiso_api,
      permiso_planos: !!u.permiso_planos,
      zona: u.zona || "Libre",
      rango_km: typeof u.rango_km==="number" ? u.rango_km : 2
    });
  }
}

function aplicarVisibilidadMenus(){
  // Mostrar Admin solo si admin o superadmin
  $("optAdmin").style.display = (session.rol==="admin"||session.rol==="superadmin") ? "block" : "none";
}

/* ==================== Geocerca y permisos ==================== */
function distanciaKm(lat1, lon1, lat2, lon2){
  const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

async function verificarAcceso(){
  // superadmin: acceso total
  if(session.rol==="superadmin"){ return true; }

  if(!session.autorizado){ return false; }

  // zona Libre => acceso total
  if(session.zona==="Libre"){ return true; }

  const z = zonasCache[session.zona];
  if(!z){ return false; }

  const pos = await getPos();
  const dist = distanciaKm(pos.lat,pos.lng,z.lat,z.lng);
  const rango = (z.radio_km ?? session.rango_km ?? 2) + TOLERANCIA_KM;
  return dist <= rango;
}

function getPos(){
  return new Promise((res,rej)=>{
    if(!navigator.geolocation) return rej("No geolocalización");
    navigator.geolocation.getCurrentPosition(
      p=>res({lat:p.coords.latitude,lng:p.coords.longitude}),
      e=>rej(e.message||"GPS error"),
      {enableHighAccuracy:true,timeout:9000}
    );
  });
}

function pintarPanelGPS(lat,lng){
  const panel=$("panelGPS");
  let z = zonasCache[session.zona] || {lat:11, lng:-74.83, radio_km:2};
  const dist = distanciaKm(lat,lng,z.lat,z.lng);
  const dentro = dist <= ( (z.radio_km??2) + TOLERANCIA_KM );
  panel.innerHTML = `
    <div>📍 <b>Lat:</b> ${lat.toFixed(5)} | <b>Lng:</b> ${lng.toFixed(5)}</div>
    <div>🏭 <b>Centro:</b> ${z.lat.toFixed(4)}, ${z.lng.toFixed(4)} (${z.radio_km??2} km)</div>
    <div>📏 <b>Distancia:</b> ${dist.toFixed(2)} km</div>
    <div>${dentro?'✅ <b>Dentro del área</b>':'🚫 <b>Fuera del área</b>'}</div>
  `;
}

/* ==================== Navegación ==================== */
const drawer=$("drawer"), mask=$("drawerMask");
$("btnMenu").onclick=()=>{ drawer.classList.add("open"); mask.style.display="block"; };
$("btnCloseDrawer").onclick=$("drawerMask").onclick=()=>{ drawer.classList.remove("open"); mask.style.display="none"; };
$("optCambiar").onclick=()=>{ localStorage.removeItem("correo_autorizado"); alert("🔄 Vuelve a cargar para ingresar otro correo."); location.reload(); };

document.querySelectorAll(".drawer .opt[data-target]").forEach(el=>{
  el.onclick = async ()=>{
    const target = el.dataset.target;
    // permisos por vista
    if(target==="inventario"){
      const ok = await ensureLogin(false) && await verificarAcceso() && (session.permiso_api || session.rol==="superadmin");
      if(!ok){ alert("🚫 Sin permiso para Inventario (API/geocerca)."); return; }
    }
    if(target==="planos"){
      const ok = await ensureLogin(false) && await verificarAcceso() && (session.permiso_planos || session.rol==="superadmin");
      if(!ok){ alert("🚫 Tu usuario no tiene permiso de Planos."); return; }
    }
    if(target==="admin"){
      const ok = await ensureLogin(false) && (session.rol==="admin"||session.rol==="superadmin");
      if(!ok){ alert("🚫 Solo administradores."); return; }
      cargarAdmin();
    }
    mostrarVista(target);
    drawer.classList.remove("open"); mask.style.display="none";
  };
});

function mostrarVista(v){
  $("view-temperaturas").style.display = (v==="temperaturas")?"block":"none";
  $("view-inventario").style.display   = (v==="inventario")?"block":"none";
  $("view-planos").style.display       = (v==="planos")?"block":"none";
  $("view-admin").style.display        = (v==="admin")?"block":"none";
  $("topTitle").textContent =
    v==="temperaturas" ? "Registro de Temperaturas" :
    v==="inventario"   ? "Inventario Por Templar" :
    v==="planos"       ? "Consulta de Planos" :
    "Administración";
}

/* ==================== Login botón header ==================== */
$("btnLogin").onclick = async ()=>{
  const ok = await ensureLogin(true);
  if(!ok) return;
  alert(`✅ Sesión iniciada como ${session.correo}\nRol: ${session.rol}\nZona: ${session.zona}`);
};

/* ==================== GPS botón ==================== */
$("btnGPS").onclick = ()=>{
  const panel=$("panelGPS");
  panel.style.display = panel.style.display==="none"?"block":"none";
  if(panel.style.display==="block"){
    if(!navigator.geolocation){ panel.textContent="⚠️ Geolocalización no soportada"; return; }
    navigator.geolocation.watchPosition(
      p=>pintarPanelGPS(p.coords.latitude,p.coords.longitude),
      e=>panel.textContent="GPS error: "+e.message,
      {enableHighAccuracy:true,timeout:10000}
    );
  }
};

/* ==================== TEMPERATURAS (como lo tenías) ==================== */
$("fecha").value = hoyISO();
$("horaInicio").value = horaAhora();
$("horaFin").value = addHours($("horaInicio").value,10);

function bindDeletes(){
  document.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=> b.closest('tr').remove());
}
bindDeletes();
$("btnAgregarFila").onclick=()=>{
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input type="time" class="hora" value="${horaAhora()}"></td>
    <td><input type="number" class="zona1" step="0.1"></td>
    <td><input type="number" class="zona2" step="0.1"></td>
    <td><input type="number" class="zona3" step="0.1"></td>
    <td><input type="number" class="zona4" step="0.1"></td>
    <td><input type="number" class="setPoint" step="0.1"></td>
    <td><button class="btn" data-del>✕</button></td>`;
  $("tbody").appendChild(tr); bindDeletes();
};

// Chart
const chart = new Chart($("chart").getContext("2d"),{
  type:'line',
  data:{labels:[],datasets:[
    {label:'Zona 1',data:[],borderColor:'red',fill:false,tension:.2},
    {label:'Zona 2',data:[],borderColor:'green',fill:false,tension:.2},
    {label:'Zona 3',data:[],borderColor:'blue',fill:false,tension:.2},
    {label:'Zona 4',data:[],borderColor:'purple',fill:false,tension:.2},
    {label:'SetPoint',data:[],borderColor:'orange',borderDash:[6,4],fill:false,tension:0}
  ]},
  options:{responsive:true,maintainAspectRatio:false,animation:false}
});

let currentCicloId="", liveRef=null;
function detachLive(){ if(liveRef){liveRef.off(); liveRef=null;} chart.data.labels=[]; chart.data.datasets.forEach(d=>d.data=[]); chart.update(); $("cabecera").textContent=""; currentCicloId=""; }
function toNumOrNull(v){ return (v===""||v==null||isNaN(v))?null:Number(v); }

$("btnRecargar").onclick = cargarActivosSelect;
["horno","fecha","turno"].forEach(id=> $(id).addEventListener("change", cargarActivosSelect));

async function cargarActivosSelect(){
  const horno=$("horno").value, fecha=$("fecha").value, turno=$("turno").value;
  const sel=$("selActivos"); sel.innerHTML='<option value="">-- Ninguno --</option>';
  const snap=await db.ref("ciclosActivos").once("value");
  snap.forEach(ch=>{
    const m=ch.val().meta||{};
    if(m.horno===horno && m.fecha===fecha && m.turno===turno){
      const o=document.createElement("option");
      o.value=ch.key; o.textContent=`${m.horno} • ${m.fecha} • ${m.turno} • ${m.horaInicio||'--'}`;
      sel.appendChild(o);
    }
  });
}
$("selActivos").onchange = e=> e.target.value ? attachLive(e.target.value) : detachLive();

function attachLive(id){
  detachLive(); currentCicloId=id;
  db.ref(`ciclosActivos/${id}/meta`).once("value").then(s=>{
    const m=s.val()||{};
    $("horaInicio").value=m.horaInicio||horaAhora();
    $("horaFin").value  =m.horaFin||addHours($("horaInicio").value,10);
    $("operarioInicio").value=m.operarioInicio||"";
    $("cabecera").textContent=`Ciclo: ${m.horno||''} | ${m.fecha||''} | ${m.turno||''}`;
  });
  liveRef=db.ref(`ciclosActivos/${id}/lecturas`);
  liveRef.on("value",snap=>{
    const arr=[]; snap.forEach(ch=>arr.push(ch.val()));
    arr.sort((a,b)=>String(a.hora).localeCompare(String(b.hora)));
    chart.data.labels = arr.map(r=>toAMPM(r.hora));
    chart.data.datasets[0].data = arr.map(r=>toNumOrNull(r.zona1));
    chart.data.datasets[1].data = arr.map(r=>toNumOrNull(r.zona2));
    chart.data.datasets[2].data = arr.map(r=>toNumOrNull(r.zona3));
    chart.data.datasets[3].data = arr.map(r=>toNumOrNull(r.zona4));
    chart.data.datasets[4].data = arr.map(r=>toNumOrNull(r.setPoint));
    chart.update();

    // pintar tabla editable
    const tbody=$("tbody"); tbody.innerHTML="";
    (arr.length?arr:[{hora:horaAhora()}]).forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><input type="time" class="hora" value="${r.hora||horaAhora()}"></td>
        <td><input type="number" class="zona1" step="0.1" value="${r.zona1??''}"></td>
        <td><input type="number" class="zona2" step="0.1" value="${r.zona2??''}"></td>
        <td><input type="number" class="zona3" step="0.1" value="${r.zona3??''}"></td>
        <td><input type="number" class="zona4" step="0.1" value="${r.zona4??''}"></td>
        <td><input type="number" class="setPoint" step="0.1" value="${r.setPoint??''}"></td>
        <td><button class="btn" data-del>✕</button></td>`;
      tbody.appendChild(tr);
    });
    bindDeletes();
  });
}

$("btnNuevo").onclick=async()=>{
  if(!$("horno").value||!$("fecha").value||!$("turno").value){ alert("Selecciona Horno/Fecha/Turno"); return; }
  // duplicado?
  const snap=await db.ref("ciclosActivos").once("value"); let dup=false;
  snap.forEach(ch=>{ const m=ch.val().meta||{}; if(m.horno===$("horno").value && m.fecha===$("fecha").value && m.turno===$("turno").value) dup=true; });
  if(dup){ alert("🚫 Ya existe un ciclo activo para ese Horno/Fecha/Turno."); return; }
  const meta={horno:$("horno").value,fecha:$("fecha").value,turno:$("turno").value,horaInicio:$("horaInicio").value||horaAhora(),horaFin:$("horaFin").value||addHours($("horaInicio").value,10),operarioInicio:$("operarioInicio").value||""};
  const ref=await db.ref("ciclosActivos").push({meta,lecturas:{}});
  await cargarActivosSelect(); $("selActivos").value=ref.key; attachLive(ref.key); alert("✅ Ciclo iniciado");
};

$("btnGuardar").onclick=async()=>{
  if(!currentCicloId){ alert("Inicia o selecciona un ciclo."); return; }
  const rows=[...document.querySelectorAll("#tbody tr")];
  const ref=db.ref(`ciclosActivos/${currentCicloId}/lecturas`);
  const snap=await ref.once("value"); const map={};
  snap.forEach(ch=>{ const v=ch.val(); if(v?.hora) map[v.hora]=ch.key; });

  const ops=[];
  for(const tr of rows){
    const hora=tr.querySelector(".hora").value; if(!hora) continue;
    const data={
      hora,
      zona1: tr.querySelector(".zona1").value===""?null:+tr.querySelector(".zona1").value,
      zona2: tr.querySelector(".zona2").value===""?null:+tr.querySelector(".zona2").value,
      zona3: tr.querySelector(".zona3").value===""?null:+tr.querySelector(".zona3").value,
      zona4: tr.querySelector(".zona4").value===""?null:+tr.querySelector(".zona4").value,
      setPoint: tr.querySelector(".setPoint").value===""?null:+tr.querySelector(".setPoint").value
    };
    ops.push( map[hora] ? ref.child(map[hora]).set(data) : ref.push(data) );
  }
  await Promise.all(ops);
  alert("✅ Lecturas guardadas");
};

$("btnFinalizar").onclick=async()=>{
  if(!currentCicloId){ alert("Selecciona ciclo."); return; }
  const horaFin=prompt("Hora fin (HH:MM):",$("horaFin").value||horaAhora()); if(horaFin===null) return;
  const operarioFin=prompt("Operario fin:",""); if(operarioFin===null) return;
  const obs=prompt("Observaciones (opcional):","")||"";

  const s=await db.ref(`ciclosActivos/${currentCicloId}`).once("value"); const node=s.val(); if(!node){ alert("No encontrado"); return; }
  node.meta=node.meta||{}; node.meta.horaFin=horaFin; node.meta.operarioFin=operarioFin; node.meta.observaciones=obs;
  await db.ref("historicos").push(node);
  await db.ref(`ciclosActivos/${currentCicloId}`).remove();
  detachLive(); await cargarActivosSelect();
  alert("✅ Ciclo finalizado");
};

/* ==================== INVENTARIO (permiso + preferencia de vista) ==================== */
const API_URL = "https://optima.tecnoglass.net/api/alutions_production/reports-producion/Detalle-produccion";
let basePendientes=[], maquinasSet=new Set(), vista="pendientes", cacheRevisadosTurno={};
let vistaTablaPend = localStorage.getItem("inv_view")==="tabla"; // preferencia

$("btnVistaToggle").textContent = vistaTablaPend ? "🃏 Vista Cards" : "📋 Vista Tabla";
function saveInvView(){ localStorage.setItem("inv_view", vistaTablaPend?"tabla":"cards"); }

/* Turno */
function turnoDet(){ const d=new Date(), h=d.getHours(); const t=(h>=7&&h<19)?"T1":"T2"; const base=new Date(d); if(t==="T2" && h<7) base.setDate(base.getDate()-1); return {turno:t, fechaISO: base.toISOString().slice(0,10)}; }
$("lblTurno").textContent = `${turnoDet().turno} (${turnoDet().fechaISO})`;

function fFecha(iso){ if(!iso) return ""; const d=new Date(iso); if(isNaN(d)) return ""; return d.toLocaleString("es-CO",{hour12:true}); }
const toNum = v=> isNaN(+v)?0:+v;
function getPlanta(machine){
  const m=(machine||"").trim().toUpperCase();
  if(["PRENSA 7-1","PRENSA 7-2","PRENSA 7-3","PRENSA 7-6","PRENSA 7-7","PRENSA 7-8"].includes(m)) return "A1";
  if(["PRENSA 7-4"].includes(m)) return "A2";
  if(["PRENSA 7-5","PRENSA 7-9","PRENSA 7-10"].includes(m)) return "A3";
  return "OTRA";
}

function popularSelectMaquinas(){
  const sel=$("fMaquina"), cur=sel.value; sel.innerHTML='<option value="">Todas</option>';
  [...maquinasSet].sort((a,b)=>a.localeCompare(b,"es",{numeric:true})).forEach(m=>{ const o=document.createElement("option"); o.value=m; o.textContent=m; sel.appendChild(o); });
  if([...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

async function fetchDep(fi,ff,dep){
  const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({Fecha_inicial:fi,Fecha_final:ff,Departamento:dep})});
  const j=await r.json(); let det=[]; if(j?.data) j.data.forEach(d=>{ if(Array.isArray(d.DetalleProduccion)) det=det.concat(d.DetalleProduccion); }); return det;
}

async function cargarInventario(){
  // permiso
  const ok = (session.rol==="superadmin") || (session.permiso_api && await verificarAcceso());
  if(!ok){ alert("🚫 Sin permiso para consumir la API."); return; }

  const fi="2025-01-01", ff=new Date().toISOString().slice(0,10);
  const [ex,tmp] = await Promise.all([fetchDep(fi,ff,"EXTRUDE"), fetchDep(fi,ff,"TMP-IN")]);
  const exMap={}, tmMap={};
  ex.forEach(e=>{
    const k=`${e.sonum}-${e.soitemnum}`;
    if(!exMap[k]) exMap[k]={pzs:0,kg:0,ultima:null,mac:"-",Part:e.Part||"-",desc:e.descrip||"-",long:e.long||"-",prio:e.prio||"-",cli:e.cliente||"-"};
    exMap[k].pzs+=toNum(e.PcProd); exMap[k].kg+=toNum(e.KgProd);
    if(!exMap[k].ultima || new Date(e.dt)>new Date(exMap[k].ultima)){ exMap[k].ultima=e.dt; exMap[k].mac=(e.MachineName||"-").trim(); }
  });
  tmp.forEach(t=>{
    const k=`${t.sonum}-${t.soitemnum}`;
    if(!tmMap[k]) tmMap[k]={pzs:0,kg:0};
    tmMap[k].pzs+=toNum(t.PcProd); tmMap[k].kg+=toNum(t.KgProd);
  });

  basePendientes=[]; maquinasSet.clear();
  Object.entries(exMap).forEach(([k,v])=>{
    const tm=tmMap[k]||{pzs:0,kg:0};
    const pzPend=(v.pzs||0)-(tm.pzs||0), kgPend=(v.kg||0)-(tm.kg||0);
    if(pzPend>0){
      const planta=getPlanta(v.mac);
      basePendientes.push({clave:k,piezasPend:pzPend,kgPend,ultimaMachine:v.mac,planta,ultimaFechaRaw:v.ultima,Part:v.Part,descrip:v.desc,long:v.long,prio:v.prio,cliente:v.cli});
      maquinasSet.add(v.mac);
    }
  });

  popularSelectMaquinas();
  $("ultimaInfoInv").textContent="Última actualización: "+ new Date().toLocaleString("es-CO",{hour12:true});
  renderInventario();
}
$("btnActualizarInv").onclick=async()=>{ const b=$("btnActualizarInv"); b.disabled=true; const old=b.textContent; b.textContent="Cargando…"; try{ await cargarInventario(); }catch(e){ alert("Error API: "+(e.message||e)); } b.disabled=false; b.textContent=old; };

function filtrarOrdenar(arr){
  const planta=$("fPlanta").value||"", maq=$("fMaquina").value||"", q=($("fBuscar").value||"").toLowerCase(), ord=$("fOrden").value;
  let res=arr.filter(r=>{
    if(planta && r.planta!==planta) return false;
    if(maq && r.ultimaMachine!==maq) return false;
    if(q){ const blob=`${r.clave} ${r.Part} ${r.descrip}`.toLowerCase(); if(!blob.includes(q)) return false; }
    return true;
  });
  res.sort((a,b)=>{
    if(ord==="fecha_desc") return new Date(b.ultimaFechaRaw)-new Date(a.ultimaFechaRaw);
    if(ord==="fecha_asc")  return new Date(a.ultimaFechaRaw)-new Date(b.ultimaFechaRaw);
    if(ord==="kg_desc")    return toNum(b.kgPend)-toNum(a.kgPend);
    if(ord==="kg_asc")     return toNum(a.kgPend)-toNum(b.kgPend);
    if(ord==="machine")    return (a.ultimaMachine||"").localeCompare((b.ultimaMachine||""),"es",{numeric:true});
    if(ord==="part")       return (a.Part||"").localeCompare((b.Part||""),"es",{numeric:true});
    if(ord==="desc")       return (a.descrip||"").localeCompare((b.descrip||""),"es",{numeric:true});
    if(ord==="desc_rev")   return (b.descrip||"").localeCompare((a.descrip||""),"es",{numeric:true});
    return 0;
  });
  return res;
}

function renderInventario(){
  // preferencia vista
  if(vistaTablaPend){ $("viewTabla").style.display="block"; $("listPend").style.display="none"; renderTablaAgrupada(); }
  else{ $("viewTabla").style.display="none"; $("listPend").style.display="block"; renderPendientesCards(); }
  actualizarTotales();
}
$("btnVistaToggle").onclick=()=>{ vistaTablaPend=!vistaTablaPend; $("btnVistaToggle").textContent = vistaTablaPend ? "🃏 Vista Cards" : "📋 Vista Tabla"; saveInvView(); renderInventario(); };
["fPlanta","fMaquina","fOrden"].forEach(id=> $(id).addEventListener("change", renderInventario));
$("fBuscar").addEventListener("input", renderInventario);

function actualizarTotales(){
  const totalGeneral = basePendientes.reduce((s,r)=>s+toNum(r.kgPend),0);
  const pendVis = filtrarOrdenar(basePendientes);
  const totalPend = pendVis.reduce((s,r)=>s+toNum(r.kgPend),0);
  // revisados turno (para porcentaje)
  const {turno,fechaISO} = turnoDet();
  const revMap = cacheRevisadosTurno[`${fechaISO}_${turno}`] || {};
  const revVis = filtrarOrdenar(Object.values(revMap).map(x=>x.record||{}));
  const totalRev = revVis.reduce((s,r)=>s+toNum(r.kgPend),0);
  const avance = totalGeneral>0 ? ((totalRev/totalGeneral)*100).toFixed(1) : "0.0";

  $("tTotalGeneral").textContent=Math.round(totalGeneral).toLocaleString();
  $("tPendientes").textContent=Math.round(totalPend).toLocaleString();
  $("tRevisados").textContent=Math.round(totalRev).toLocaleString();
  $("tAvance").textContent=avance+"%";
}

function renderPendientesCards(){
  const cont=$("listPend"); cont.innerHTML="";
  const arr=filtrarOrdenar(basePendientes);
  if(arr.length===0){ cont.textContent="Sin pendientes con los filtros actuales."; return; }
  const frag=document.createDocumentFragment();
  arr.forEach(r=>{
    const div=document.createElement("div"); div.className="card";
    div.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center"><div class="badge">Máquina: ${r.ultimaMachine}</div><div class="badge">${r.planta}</div></div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:6px">
        <div><b>SOITEM:</b> ${r.clave}</div>
        <div><b>Fecha:</b> ${fFecha(r.ultimaFechaRaw)}</div>
        <div><b>Part:</b> ${r.Part}</div>
        <div><b>Prioridad:</b> ${r.prio}</div>
        <div style="grid-column:1/3"><b>Descripción:</b> ${r.descrip}</div>
        <div><b>Pzs Pend:</b> ${r.piezasPend}</div>
        <div><b>Kg Pend:</b> ${Math.round(r.kgPend)}</div>
      </div>
    `;
    frag.appendChild(div);
  });
  cont.appendChild(frag);
}

/* ===== Tabla agrupada simple ===== */
$("agrupacionTabla").onchange = renderTablaAgrupada;
$("btnRecargarTabla").onclick = renderTablaAgrupada;
function renderTablaAgrupada(){
  const arr=filtrarOrdenar(basePendientes);
  const agr=$("agrupacionTabla").value; // part | desc
  const grupos={};
  arr.forEach(r=>{ const k=agr==="part"?r.Part:r.descrip; (grupos[k]||(grupos[k]=[])).push(r); });

  const cont=$("tablaAgrupada"); cont.innerHTML="";
  Object.entries(grupos).forEach(([k,items])=>{
    const w=document.createElement("div"); w.style.marginBottom="12px";
    w.innerHTML=`<div class="badge" style="margin:6px 0">${k}</div>`;
    const tbl=document.createElement("table");
    tbl.innerHTML=`<thead><tr><th>SOITEM</th><th>Máquina</th><th>Pzs</th><th>Kg</th><th>Prioridad</th></tr></thead><tbody></tbody>`;
    const tb=tbl.querySelector("tbody");
    items.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.clave}</td><td>${r.ultimaMachine}</td><td>${r.piezasPend}</td><td>${Math.round(r.kgPend)}</td><td>${r.prio}</td>`;
      tb.appendChild(tr);
    });
    w.appendChild(tbl); cont.appendChild(w);
  });
}

/* ==================== PLANOS (modal seguro) ==================== */
const PLANOS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlsUCkIwRggf4CcUkfq239hl5UKRE86B3FycdB14sgIs5OIeFuqKQjlhzezzNNWJa6WEPy_URJtDB_/pub?gid=1893719309&single=true&output=csv";
const CACHE_KEY = "planosCacheCSV";
let planosData=[], filtrados=[], indexRender=0, PAGE_SIZE=200;

function parseCSV(csv){
  const rows = csv.trim().split("\n").map(r=>r.split(","));
  const headers = rows[0].map(h=>h.trim());
  return rows.slice(1).map(r=>{ const o={}; headers.forEach((h,i)=>o[h]= (r[i]||"").trim()); return o; });
}
async function cargarPlanos(){
  const body=$("tbodyPlanos"); body.innerHTML=`<tr><td colspan="2">Cargando…</td></tr>`;
  const cache=localStorage.getItem(CACHE_KEY); if(cache) planosData=parseCSV(cache);
  try{ const resp=await fetch(PLANOS_URL); const csv=await resp.text(); if(csv.length>100){ localStorage.setItem(CACHE_KEY,csv); planosData=parseCSV(csv);} }catch(e){}
  renderPlanos(true);
}
function renderPlanos(reset){
  const body=$("tbodyPlanos");
  if(reset){
    const q=($("buscarPlano").value||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    filtrados = planosData.filter(p=> ((p.NOMBRE||p.Nombre||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")).includes(q) );
    indexRender=0; body.innerHTML="";
  }
  const next=filtrados.slice(indexRender,indexRender+PAGE_SIZE);
  const frag=document.createDocumentFragment();
  next.forEach(p=>{
    const nombre=(p.NOMBRE||p.Nombre||"").replace(".pdf","").trim();
    const link = p.LINK || p.Link || p.ARCHIVO || "#";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td style="text-align:center">${nombre||"Sin nombre"}</td>
                  <td style="text-align:center"><button class="btn primary">Abrir</button></td>`;
    tr.querySelector("button").onclick=()=> abrirPlanoEnModal(nombre, link);
    frag.appendChild(tr);
  });
  body.appendChild(frag); indexRender+=PAGE_SIZE;
}
function abrirPlanoEnModal(nombre, url){
  if(!url || url==="#") return;
  $("mdPlanoTitulo").textContent=nombre;
  // Visor sin UI de descarga/compartir (Google viewer minimal)
  const viewer = `https://docs.google.com/gview?embedded=1&rm=minimal&url=${encodeURIComponent(url)}`;
  $("viewerPlano").src = viewer;
  $("modalPlanos").style.display="flex";
}
$("btnCerrarPlano").onclick=()=>{ $("modalPlanos").style.display="none"; $("viewerPlano").src=""; };
$("btnRecargarPlanos").onclick=cargarPlanos;
$("buscarPlano").oninput = ()=>renderPlanos(true);
$("tablaPlanos").parentElement.onscroll = e=>{
  const el=e.target; if(el.scrollTop+el.clientHeight>=el.scrollHeight-30 && indexRender<filtrados.length){ renderPlanos(false); }
};

/* ==================== ADMIN (usuarios + zonas) ==================== */
async function cargarAdmin(){
  // select zonas
  const sel=$("admZona"); sel.innerHTML='<option value="">Seleccione zona…</option>';
  const zSnap=await db.ref("seguridad/zonas").once("value"); const zs=zSnap.val()||{};
  Object.keys(zs).forEach(k=>{ const o=document.createElement("option"); o.value=k; o.textContent=k; sel.appendChild(o); });
  // lista zonas
  const lz=$("listaZonas"); lz.innerHTML="";
  Object.entries(zs).forEach(([k,v])=>{
    const d=document.createElement("div");
    d.innerHTML=`<span class="badge">${k}</span> lat:${v.lat}, lng:${v.lng}, radio:${v.radio_km}km`;
    lz.appendChild(d);
  });
  // lista usuarios
  const lu=$("listaUsuarios"); lu.innerHTML="";
  const uSnap=await db.ref("seguridad/usuarios").once("value"); const us=uSnap.val()||{};
  Object.entries(us).forEach(([k,v])=>{
    const d=document.createElement("div");
    d.style.marginBottom="6px";
    d.innerHTML=`<span class="badge">${k}</span> · rol:${v.rol} · autorizado:${!!v.autorizado} · API:${!!v.permiso_api} · Planos:${!!v.permiso_planos} · zona:${v.zona} · rango:${v.rango_km||2}km`;
    d.onclick=()=>{ // cargar en el formulario para editar
      $("admCorreo").value=k.replace(/_/g,'.').replace('.com','.com').replace('.co','.co').replace('tecnoglass_com','tecnoglass.com');
      $("admRol").value=v.rol||"user";
      $("admAutorizado").checked=!!v.autorizado;
      $("admAPI").checked=!!v.permiso_api;
      $("admPlanos").checked=!!v.permiso_planos;
      $("admZona").value=v.zona||"";
      $("admRango").value=v.rango_km||2;
    };
    lu.appendChild(d);
  });
}

$("btnGuardarUsuario").onclick=async()=>{
  const correo = $("admCorreo").value.trim();
  if(!correo){ alert("Correo requerido"); return; }
  const key = correoToKey(correo);
  const payload = {
    rol: $("admRol").value,
    autorizado: $("admAutorizado").checked,
    permiso_api: $("admAPI").checked,
    permiso_planos: $("admPlanos").checked,
    zona: $("admZona").value || "Libre",
    rango_km: parseFloat($("admRango").value||"2")
  };
  await db.ref("seguridad/usuarios/"+key).update(payload);
  alert("✅ Usuario guardado"); cargarAdmin();
};

$("btnGuardarZona").onclick=async()=>{
  const nombre=$("admNombreZona").value.trim(); if(!nombre){ alert("Nombre de zona requerido"); return; }
  const lat=parseFloat($("admLat").value), lng=parseFloat($("admLng").value), radio=parseFloat($("admRadio").value||"2");
  if(isNaN(lat)||isNaN(lng)){ alert("Lat/Lng inválidos"); return; }
  await db.ref("seguridad/zonas/"+nombre).update({lat,lng,radio_km:radio});
  alert("✅ Zona guardada"); cargarAdmin();
};

/* ==================== Boot ==================== */
window.addEventListener("DOMContentLoaded", async ()=>{
  // intenta levantar sesión si ya hay correo
  if(localStorage.getItem("correo_autorizado")){
    await ensureLogin(false);
  }
  // por defecto muestra temperaturas
  mostrarVista("temperaturas");
});
</script>
</body>
</html>