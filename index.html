$('btnActualizarInv').onclick = async () => {
  const b = $('btnActualizarInv');
  const inicioTotal = performance.now();
  b.disabled = true;
  const oldText = b.textContent;
  b.textContent = "Cargando...";

  try {
    // üöÄ Disparamos geolocalizaci√≥n y API en paralelo
    const ubicacionPromise = verificarUbicacion();
    const accesoPromise = verificarAccesoCompleto();

    // Mientras tanto, ejecutamos el fetch de API
    const apiInicio = performance.now();
    const apiPromise = cargarPendientes(); // no esperes aqu√≠

    // Obtenemos permiso y ubicaci√≥n (en paralelo)
    const [acceso, ubicacion] = await Promise.allSettled([accesoPromise, ubicacionPromise]);
    const pos = ubicacion.value || {};
    const lat = pos.lat || null, lon = pos.lon || null, distancia = pos.distancia || null;

    // Si no tiene acceso ‚Üí cancelar antes de esperar el fetch
    if (acceso.status === "fulfilled" && !acceso.value) {
      await registrarActividad("Consulta API", "Sin autorizaci√≥n", apiInicio, performance.now(), lat, lon, distancia);
      alert("üö´ No tienes autorizaci√≥n o est√°s fuera del rango.");
      b.textContent = oldText;
      b.disabled = false;
      return;
    }

    // Esperamos la API con l√≠mite m√°ximo de 20 s
    const apiResponse = await Promise.race([
      apiPromise,
      new Promise((_, rej) => setTimeout(() => rej(new Error("Timeout API")), 20000))
    ]);
    const apiFin = performance.now();

    await registrarActividad("Consulta API", "√âxito", apiInicio, apiFin, lat, lon, distancia);
  } catch (e) {
    await registrarActividad("Consulta API", "Error", inicioTotal, performance.now());
    console.error("‚ùå Error:", e);
    alert("Error en la consulta de API: " + (e.message || e));
  }

  b.textContent = oldText;
  b.disabled = false;
};















