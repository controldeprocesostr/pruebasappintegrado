<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#121212">
  <title>Registro de Temperaturas + Inventario</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase compat (v9 compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#121212; --panel:#1e1e1e; --panel-2:#151515;
      --accent:#00e5ff; --accent-2:#ffae00; --muted:#9aa9b1;
      --input-bg:#fff; --input-color:#000;
      --ok:#10b981; --warn:#f59e0b; --border:#2b2b2b; --soft:#222;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:Arial,Helvetica,sans-serif;color:#fff}
    .wrap{max-width:1120px;margin:12px auto;padding:12px}

    /* Header */
    .header-bar{display:flex;align-items:center;gap:10px;justify-content:center;position:relative;margin-bottom:10px}
    .header-title{color:var(--accent);font-weight:800;font-size:22px;text-align:center}
    .hamb{position:absolute;left:0;top:50%;transform:translateY(-50%);background:transparent;border:1px solid var(--soft);color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
    .hamb:active{filter:brightness(.9)}

    /* Cards */
    .card{background:#1b1b1b;border:1px solid #2e2e2e;border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,.35);transition:transform .15s ease, box-shadow .2s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,.5)}

    label{display:block;margin:6px 0 4px;font-weight:700;color:#ddd}
    input, select, textarea, button{box-sizing:border-box;border-radius:6px;border:1px solid var(--border);padding:8px}
    input,select,textarea{width:100%;background:#fff;color:#000}
    button{cursor:pointer;border:none;font-weight:700}
    .btn-primary{background:var(--accent);color:#000}
    .btn-outline{background:transparent;border:2px solid var(--accent);color:var(--accent)}
    .btn-danger{background:var(--accent-2);color:#000}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .actions{display:flex;gap:10px;align-items:center}
    .hint{color:var(--muted);font-size:13px;margin-top:8px}
    canvas{width:100% !important;height:360px !important;background:#151515;border-radius:6px}
    .hidden{display:none!important}

    /* Drawer */
    .drawer-mask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:900}
    .drawer{position:fixed;right:0;top:0;height:100%;width:300px;max-width:92vw;background:#0f0f0f;border-left:1px solid var(--soft);
      transform:translateX(100%);transition:transform .25s ease;z-index:1000;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer .head{padding:14px;border-bottom:1px solid var(--soft);font-weight:800;color:#fff;display:flex;justify-content:space-between;align-items:center}
    .drawer .body{padding:10px;display:flex;flex-direction:column;gap:8px}
    .drawer .opt{background:#121212;border:1px solid var(--soft);padding:12px;border-radius:10px;cursor:pointer}
    .drawer .opt:hover{filter:brightness(1.05)}

    /* Panel GPS */
    #panelGPS{
      position:fixed;bottom:60px;right:10px;background:#111;padding:10px 14px;
      border:1px solid #00e5ff;border-radius:10px;color:#0ff;font-size:12px;
      font-family:monospace;z-index:9999;box-shadow:0 0 10px rgba(0,229,255,0.5);display:none;
    }
    #btnGPS{
      position:fixed;bottom:10px;right:10px;background:#00e5ff;color:#000;
      border:none;padding:6px 10px;border-radius:8px;font-weight:bold;cursor:pointer;
      z-index:10000;box-shadow:0 0 10px rgba(0,229,255,0.5);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header-bar">
      <button class="hamb" id="btnMenu">‚ò∞</button>
      <div class="header-title" id="topTitle">Registro de Temperaturas</div>
    </div>

<!-- ==================== üìã Vistas principales ==================== -->
    <div id="vistaTemperaturas" class="card">
      <h2>Registro de Temperaturas</h2>
      <div class="grid4">
        <div>
          <label>Horno</label>
          <select id="horno">
            <option value="">-- Selecciona --</option>
            <option>Horno 5</option>
            <option>Horno 7-3</option>
            <option>Horno 9-3</option>
          </select>
        </div>
        <div>
          <label>Fecha</label>
          <input type="date" id="fecha">
        </div>
        <div>
          <label>Turno</label>
          <select id="turno">
            <option value="">-- Selecciona --</option>
            <option>T1</option><option>T2</option><option>T3</option>
          </select>
        </div>
        <div>
          <label>Operario (inicio)</label>
          <input type="text" id="operario" placeholder="nombre">
        </div>
      </div>

      <div class="grid4">
        <div>
          <label>Hora inicio</label>
          <input type="time" id="horaInicio">
        </div>
        <div>
          <label>Hora fin (auto +10h)</label>
          <input type="time" id="horaFin">
        </div>
      </div>

      <div class="hint">Si existe un ciclo activo (mismo Horno/Fecha/Turno) aparecer√° en "Ciclos activos".</div>
      <div class="actions" style="margin-top:8px">
        <button class="btn-primary">Iniciar ciclo</button>
      </div>
    </div>

    <div id="vistaInventario" class="card hidden">
      <h2>Inventario Por Templar</h2>
      <p>Gesti√≥n y trazabilidad de piezas en proceso.</p>
      <button class="btn-primary">Cargar Inventario</button>
      <div class="hint">Conecta con la API de inventario para obtener los datos actuales.</div>
    </div>

    <div id="vistaPlanos" class="card hidden">
      <h2>Consulta de Planos</h2>
      <p>Acceso directo a los planos en Excel.</p>
      <button class="btn-primary">Abrir listado de planos</button>
    </div>
  </div>

  <!-- ==================== üìÇ Drawer / Men√∫ lateral ==================== -->
  <div class="drawer" id="drawer">
    <div class="head">
      <span>Men√∫ principal</span>
      <button id="cerrarDrawer" style="background:none;border:none;color:#fff;font-size:20px;">‚úñ</button>
    </div>
    <div class="body">
      <div class="opt" data-target="temperaturas">Registro de Temperaturas<br><small>Lecturas por zona y ciclo</small></div>
      <div class="opt" data-target="inventario">Inventario Por Templar<br><small>Gesti√≥n y trazabilidad</small></div>
      <div class="opt" data-target="planos">Consulta de Planos<br><small>Acceso directo a los planos en Excel</small></div>
      <div class="opt" id="btnActualizarZona">üõ†Ô∏è Actualizar zona Tecnoglass<br><small>Solo administrador</small></div>
      <div class="opt" id="btnCambiarUsuario">üë§ Cambiar usuario<br><small>Permite volver a iniciar con otro correo</small></div>
    </div>
  </div>
  <div class="drawer-mask" id="drawerMask"></div>

  <!-- ==================== üì° Panel GPS ==================== -->
  <div id="panelGPS"></div>
  <button id="btnGPS">üì° GPS</button>

<script>
"use strict";

/* ==================== üîß Firebase ==================== */
const firebaseConfig = {
  apiKey: "AIzaSyAB4UlwaVJzc4U4VbmddLf4mejKAOvTufw",
  authDomain: "hornosapp-60887.firebaseapp.com",
  databaseURL: "https://hornosapp-60887-default-rtdb.firebaseio.com",
  projectId: "hornosapp-60887",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ==================== üß∞ Helpers ==================== */
const $ = (id) => document.getElementById(id);
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
const pad2 = (n)=> String(n).padStart(2,"0");
const hoyISO = ()=> new Date().toISOString().slice(0,10);

/* ==================== üîê Estado global ==================== */
let usuarioCorreoActual = "";
let accesoPermitido = localStorage.getItem("accesoPermitido") === "true";

/* ==================== üó∫Ô∏è Zona Tecnoglass (Firebase) ==================== */
let ZONA = { nombre:"Tecnoglass S.A.S - Barranquilla", lat: 11.0000, lng: -74.8300, radio_km: 8 };

firebase.database().ref("seguridad/zonas/TecnoglassBarranquilla").on("value", snap=>{
  if (snap.exists()) ZONA = snap.val();
});

/* ==================== üß± Inicializar nodo de seguridad si falta ==================== */
async function inicializarSeguridadSiFalta(){
  const ref = firebase.database().ref("seguridad");
  const snap = await ref.once("value");
  if (snap.exists()) return; // ya existe

  const dataInicial = {
    zonas: {
      TecnoglassBarranquilla: { nombre: ZONA.nombre, lat: ZONA.lat, lng: ZONA.lng, radio_km: ZONA.radio_km },
    },
    usuarios: {
      "gary_maldonado_tecnoglass_com": { autorizado: true, zona: "TecnoglassBarranquilla" },
      "operario1_tecnoglass_com":     { autorizado: true, zona: "TecnoglassBarranquilla" },
      "externo_gmail_com":            { autorizado: true, zona: "Libre" }
    }
  };
  await ref.set(dataInicial);
  console.log("‚úÖ Nodo 'seguridad' creado.");
}

/* ==================== üìç Geolocalizaci√≥n ==================== */
function obtenerUbicacionActual(){
  return new Promise((resolve, reject)=>{
    if (!navigator.geolocation) return reject("Geolocalizaci√≥n no soportada");
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
      err => reject(err.message || "Error al obtener ubicaci√≥n"),
      { enableHighAccuracy:true, timeout: 9000 }
    );
  });
}
function distanciaKm(lat1, lon1, lat2, lon2){
  const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ==================== ‚úÖ Habilitar/Deshabilitar men√∫s ==================== */
function habilitarAccesoTotal(){
  accesoPermitido = true;
  localStorage.setItem("accesoPermitido","true");
  document.querySelectorAll(".drawer .opt").forEach(o=>{
    o.style.opacity="1";
    o.style.pointerEvents="auto";
  });
}
function deshabilitarAcceso(){
  accesoPermitido = false;
  localStorage.removeItem("accesoPermitido");
  document.querySelectorAll(".drawer .opt").forEach(o=>{
    const t = o.dataset.target;
    if (t==="inventario" || t==="planos"){
      o.style.opacity="0.5";
      o.style.pointerEvents="none";
    }
  });
}

/* ==================== üîé Verificaci√≥n de zona/usuario ==================== */
async function verificarZonaPermitida(correo){
  const seguridadSnap = await firebase.database().ref("seguridad").once("value");
  const seguridad = seguridadSnap.val() || {};
  const key = correo.toLowerCase().replace(/\./g,"_").replace(/@/g,"_");
  const usuario = seguridad.usuarios?.[key];

  if (!usuario){
    alert("üö´ Este usuario no est√° registrado en seguridad.");
    return false;
  }

  if (usuario.zona === "Libre"){
    console.log("üü¢ Usuario con zona Libre: sin restricci√≥n.");
    return true;
  }

  const zona = seguridad.zonas?.[usuario.zona];
  if (!zona){
    alert("‚ö†Ô∏è La zona asignada no existe en Firebase.");
    return false;
  }

  let pos;
  try {
    pos = await obtenerUbicacionActual();
  } catch(e){
    alert("‚ö†Ô∏è No se pudo obtener tu ubicaci√≥n: " + e);
    return false;
  }

  const dist = distanciaKm(pos.lat,pos.lng,zona.lat,zona.lng);
  const dentro = dist <= (zona.radio_km + 2); // tolerancia

  // Panel
  actualizarPanelGPS(pos.lat, pos.lng, zona, dist, dentro);

  if (!dentro){
    alert(`üö´ Fuera del √°rea (${dist.toFixed(2)} km del centro).`);
  }
  return dentro;
}

/* ==================== üõ∞Ô∏è Panel GPS ==================== */
function actualizarPanelGPS(lat, lng, zona, dist, dentro){
  const el = $("panelGPS");
  el.innerHTML = `
    <div>üìç <b>Lat:</b> ${lat.toFixed(5)} | <b>Lng:</b> ${lng.toFixed(5)}</div>
    <div>üè≠ <b>Centro:</b> ${zona.lat.toFixed(4)}, ${zona.lng.toFixed(4)}</div>
    <div>üìè <b>Distancia:</b> ${dist.toFixed(2)} km</div>
    <div>${dentro ? "‚úÖ <b>Dentro del √°rea</b>" : "üö´ <b>Fuera del √°rea</b>"}</div>
  `;
}
function iniciarWatcherGPS(){
  if (!navigator.geolocation){
    $("panelGPS").textContent = "‚ö†Ô∏è Geolocalizaci√≥n no soportada";
    return;
  }
  navigator.geolocation.watchPosition(
    pos=>{
      const { latitude:lat, longitude:lng } = pos.coords;
      const dist = distanciaKm(lat,lng,ZONA.lat,ZONA.lng);
      const dentro = dist <= (ZONA.radio_km + 2);
      actualizarPanelGPS(lat,lng,ZONA,dist,dentro);

      // Revocar si sale del √°rea
      if (!dentro && accesoPermitido){
        deshabilitarAcceso();
        console.warn("üö´ Usuario sali√≥ del √°rea; acceso restringido.");
      }
    },
    err=>{
      $("panelGPS").textContent = "‚ùå Error GPS: " + err.message;
    },
    { enableHighAccuracy:true, timeout:10000 }
  );
}
$("btnGPS").addEventListener("click", ()=>{
  const p = $("panelGPS");
  const visible = p.style.display === "block";
  p.style.display = visible ? "none" : "block";
  if (!visible) iniciarWatcherGPS();
});

/* ==================== üß≠ Drawer y navegaci√≥n ==================== */
const drawer = $("drawer");
const mask   = $("drawerMask");

$("btnMenu").addEventListener("click", async ()=>{
  drawer.classList.add("open");
  mask.style.display = "block";

  const correo = localStorage.getItem("correo_autorizado");
  if (correo){
    const dentro = await verificarZonaPermitida(correo);
    if (dentro) habilitarAccesoTotal();
    else deshabilitarAcceso();
  }
});
$("cerrarDrawer").addEventListener("click", cerrarDrawer);
$("drawerMask").addEventListener("click", cerrarDrawer);
function cerrarDrawer(){ drawer.classList.remove("open"); mask.style.display="none"; }

/* Clicks en opciones del men√∫ */
document.querySelectorAll(".drawer .opt").forEach(opt=>{
  opt.addEventListener("click", ()=>{
    const t = opt.dataset.target;
    if (t === "temperaturas") { mostrarVista("temperaturas"); }
    if (t === "inventario") {
      if (!accesoPermitido) return alert("üö´ Requiere estar en zona/autorizado.");
      mostrarVista("inventario"); cargarInventario();
    }
    if (t === "planos") {
      if (!accesoPermitido) return alert("üö´ Requiere estar en zona/autorizado.");
      mostrarVista("planos"); verificarAccesoPlanos();
    }
  });
});

function mostrarVista(v){
  // Oculta todas
  ["vistaTemperaturas","vistaInventario","vistaPlanos"].forEach(id=> $(id).classList.add("hidden"));
  if (v==="temperaturas") { $("vistaTemperaturas").classList.remove("hidden"); $("topTitle").textContent="Registro de Temperaturas"; }
  if (v==="inventario")   { $("vistaInventario").classList.remove("hidden");   $("topTitle").textContent="Inventario Por Templar"; }
  if (v==="planos")       { $("vistaPlanos").classList.remove("hidden");       $("topTitle").textContent="Consulta de Planos"; }
  setTimeout(cerrarDrawer, 150);
}

/* ==================== üë§ Usuario / permisos ==================== */
$("btnCambiarUsuario").addEventListener("click", ()=>{
  localStorage.removeItem("correo_autorizado");
  localStorage.removeItem("accesoPermitido");
  alert("üîÑ Usuario borrado. Recarga para ingresar otro correo.");
  location.reload();
});

$("btnActualizarZona").addEventListener("click", async ()=>{
  const correo = localStorage.getItem("correo_autorizado") || "";
  if (!correo.includes("gary.maldonado@tecnoglass.com")){
    alert("üö´ Solo administradores pueden actualizar la zona.");
    return;
  }
  if (!confirm("¬øActualizar centro/radio de TecnoglassBarranquilla?")) return;
  await firebase.database().ref("seguridad/zonas/TecnoglassBarranquilla").update({
    lat: 11.0000,
    lng: -74.8300,
    radio_km: 8
  });
  alert("‚úÖ Zona actualizada.");
});

/* ==================== üìë Planos (placeholder) ==================== */
async function verificarAccesoPlanos(){
  // Aqu√≠ puedes a√±adir l√≥gica adicional de permisos por lista (planosAcceso)
  // De momento solo carga una tabla de ejemplo / o tu carga real si ya la tienes.
  console.log("‚ÑπÔ∏è Acceso a planos verificado.");
  // TODO: reemplazar con tu carga real de planos si aplica.
}

/* ==================== üì¶ Inventario (placeholder) ==================== */
async function cargarInventario(){
  console.log("‚ÑπÔ∏è Cargar inventario: implementa tu fetch/API aqu√≠.");
  // TODO: trae datos reales y puebla la vista
}

/* ==================== üöÄ Bootstrap al cargar ==================== */
window.addEventListener("DOMContentLoaded", async ()=>{
  await inicializarSeguridadSiFalta();

  // Si no hay correo, pedirlo
  let correo = localStorage.getItem("correo_autorizado");
  if (!correo){
    correo = prompt("Introduce tu correo corporativo (ej: gary.maldonado@tecnoglass.com):");
    if (!correo){
      alert("‚ö†Ô∏è No se puede continuar sin correo.");
      deshabilitarAcceso();
      return;
    }
    localStorage.setItem("correo_autorizado", correo);
  }
  usuarioCorreoActual = correo;

  // Modo admin: si es tu correo, acceso total garantizado
  const esAdmin = correo.toLowerCase().includes("gary.maldonado@tecnoglass.com");

  // Verificar zona (o conceder por admin)
  try{
    const dentro = esAdmin ? true : await verificarZonaPermitida(correo);
    if (dentro) habilitarAccesoTotal(); else deshabilitarAcceso();
  }catch(e){
    console.warn("No se pudo verificar zona:", e);
    if (esAdmin) habilitarAccesoTotal();
    else deshabilitarAcceso();
  }

  // Vista por defecto
  mostrarVista("temperaturas");
});
</script>

<style>
  /* ===== UX refinements ===== */
  button:active { transform: scale(0.97); }
  input:disabled, select:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }
  small { color: var(--muted); }

  /* Scrollbar minimal */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }
  ::-webkit-scrollbar-track { background: var(--panel-2); }

  /* Responsive */
  @media(max-width:640px){
    .grid4{grid-template-columns:repeat(2,1fr);}
    .header-title{font-size:18px;}
  }
</style>

</body>
</html>
