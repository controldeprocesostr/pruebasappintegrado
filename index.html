<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#121212">
  <title>ERP ProducciÃ³n â€“ Tecnoglass</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    :root{
      --bg:#121212; --panel:#1e1e1e; --panel2:#151515;
      --accent:#00e5ff; --accent2:#ffae00;
      --muted:#9aa9b1; --input-bg:#fff; --input-color:#000;
      --ok:#10b981; --warn:#f59e0b; --danger:#e74c3c;
      --soft:#222; --border:#333;
    }

    html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#fff}
    .wrap{max-width:1120px;margin:10px auto;padding:10px}

    /* Header */
    .header-bar{display:flex;align-items:center;justify-content:center;gap:10px;position:relative;margin-bottom:12px}
    .header-title{color:var(--accent);font-size:22px;font-weight:800;text-align:center}
    .hamb{position:absolute;left:0;top:50%;transform:translateY(-50%);border:1px solid var(--soft);background:transparent;color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
    .user-chip{position:absolute;right:0;top:50%;transform:translateY(-50%);display:flex;align-items:center;gap:6px}
    .user-chip button{border:1px solid var(--soft);border-radius:8px;padding:6px 10px;background:transparent;color:#fff;cursor:pointer}
    .user-chip small{color:var(--muted)}

    /* Cards */
    .card{background:var(--panel);border:1px solid var(--soft);border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,.4)}
    label{font-weight:700;margin:6px 0 4px;display:block;color:#ddd}
    input,select,button{border-radius:6px;padding:8px;border:1px solid var(--border)}
    input,select{width:100%;background:var(--input-bg);color:var(--input-color)}
    button{cursor:pointer;font-weight:700}
    .btn-primary{background:var(--accent);color:#000}
    .btn-outline{border:2px solid var(--accent);background:transparent;color:var(--accent)}
    .btn-danger{background:var(--accent2);color:#000}

    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .hidden{display:none!important}

    /* Drawer */
    .drawer-mask{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:900}
    .drawer{position:fixed;right:0;top:0;width:300px;height:100%;max-width:92vw;background:#0f0f0f;border-left:1px solid var(--soft);transform:translateX(100%);transition:.3s;z-index:1000;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer .head{padding:12px;border-bottom:1px solid var(--soft);display:flex;justify-content:space-between;align-items:center;font-weight:800}
    .drawer .body{padding:10px;display:flex;flex-direction:column;gap:8px}
    .drawer .opt{background:#1a1a1a;border:1px solid var(--soft);border-radius:10px;padding:12px;cursor:pointer}
    .drawer .opt:hover{filter:brightness(1.1)}
    .drawer small{color:var(--muted)}

    /* Planos tabla */
    #tablaPlanos{width:100%;border-collapse:collapse;background:#1b1b1b;border-radius:8px;overflow:hidden}
    #tablaPlanos th,#tablaPlanos td{padding:8px;text-align:center;border-bottom:1px solid var(--soft)}
    #tablaPlanos th{background:#111;color:var(--accent);font-weight:700}
    #tablaPlanos tr:hover{background:#222;cursor:pointer}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1200}
    .win{background:#1a1a1a;border:1px solid var(--border);border-radius:12px;max-width:900px;width:96vw;max-height:90vh;display:flex;flex-direction:column;overflow:hidden}
    .win .head{padding:10px;border-bottom:1px solid var(--soft);display:flex;justify-content:space-between;align-items:center}
    .win .body{flex:1;overflow:auto;padding:0;background:#0b0b0b}
    .pdf-frame{width:100%;height:80vh;border:0}
    .close{border:1px solid var(--soft);background:#151515;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}

    /* Admin */
    .admin-only{display:none}

    @media(max-width:900px){
      .grid4{grid-template-columns:repeat(2,1fr)}
    }
    @media(max-width:600px){
      .grid4{grid-template-columns:1fr}
    }
  </style>
</head>

<body class="no-select">
  <div class="wrap">
    <div class="header-bar">
      <button id="btnMenu" class="hamb">â˜°</button>
      <div id="topTitle" class="header-title">Registro de Temperaturas</div>
      <div class="user-chip">
        <small id="lblUser">â€”</small>
        <button id="btnLogin">Iniciar sesiÃ³n</button>
        <button id="btnLogout" class="hidden">Salir</button>
      </div>
    </div>

    <!-- ===== VISTA: TEMPERATURAS ===== -->
    <div id="view-temperaturas">
      <div class="card">
        <h3 style="margin:0;color:var(--accent)">Registro de Temperaturas</h3>
        <div class="grid4">
          <div><label>Horno</label><select id="horno">
            <option>Horno 5</option><option>Horno 7-3</option><option>Horno 9-1</option>
            <option>Horno 9-2</option><option>Horno Italiano</option>
          </select></div>
          <div><label>Fecha</label><input type="date" id="fecha"></div>
          <div><label>Turno</label><select id="turno"><option>T1</option><option>T2</option></select></div>
          <div><label>Operario</label><input id="operarioInicio" placeholder="nombre"></div>
        </div>
        <button class="btn-primary" id="btnNuevo">Iniciar ciclo</button>
      </div>

      <div class="card">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <!-- ===== VISTA: INVENTARIO ===== -->
    <div id="view-inventario" class="hidden">
      <div class="card">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="fBuscar" placeholder="Buscar...">
          <button id="btnActualizarInv" class="btn-primary">Actualizar</button>
          <button id="btnVistaToggle" class="btn-outline">ðŸ“‹ Vista Tabla</button>
        </div>
        <div id="listPend" style="margin-top:10px"></div>
      </div>
    </div>

    <!-- ===== VISTA: PLANOS ===== -->
    <div id="view-planos" class="hidden">
      <div class="card">
        <div style="display:flex;gap:10px;align-items:center">
          <input id="buscarPlano" placeholder="Buscar plano...">
          <button id="btnRecargarPlanos" class="btn-primary">ðŸ”„ Recargar</button>
        </div>
        <div style="max-height:70vh;overflow:auto;margin-top:10px">
          <table id="tablaPlanos">
            <thead><tr><th>Nombre</th><th>Enlace</th></tr></thead>
            <tbody id="tbodyPlanos"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== MODAL ===== -->
    <div class="modal" id="modalInv">
      <div class="win">
        <div class="head"><b id="mdTitulo"></b><button id="btnCloseInv" class="close">Cerrar</button></div>
        <div class="body">
          <iframe id="framePlano" class="pdf-frame"></iframe>
        </div>
      </div>
    </div>

    <!-- ===== DRAWER ===== -->
    <div id="drawer" class="drawer">
      <div class="head"><span>MenÃº</span><button id="btnCloseDrawer">âœ•</button></div>
      <div class="body">
        <div class="opt" data-target="temperaturas"><b>Registro de Temperaturas</b></div>
        <div class="opt" data-target="inventario"><b>Inventario Por Templar</b></div>
        <div class="opt" data-target="planos"><b>Consulta de Planos</b></div>
        <div class="opt admin-only" data-target="admin"><b>ðŸ‘‘ Panel Administrador</b></div>
      </div>
    </div>
    <div id="drawerMask" class="drawer-mask"></div>

    <!-- ===== VISTA ADMIN ===== -->
    <div id="view-admin" class="hidden">
      <div class="card">
        <h3 style="color:var(--accent)">GestiÃ³n de usuarios y permisos</h3>
        <div class="grid4">
          <div><label>Correo</label><input id="admCorreo" type="email" placeholder="nombre@tecnoglass.com"></div>
          <div><label>Rol</label><select id="admRol"><option>user</option><option>admin</option></select></div>
          <div><label>Zona</label><select id="admZona"><option>TecnoglassBarranquilla</option><option>Libre</option></select></div>
          <div><button id="btnAdmAgregar" class="btn-primary">Guardar</button><button id="btnAdmEliminar" class="btn-danger">Eliminar</button></div>
        </div>
      </div>

      <div class="card">
        <h3 style="color:var(--accent)">Actualizar zona Tecnoglass</h3>
        <div class="grid4">
          <div><label>Latitud</label><input id="admLat" type="number" step="0.0001" value="11.0000"></div>
          <div><label>Longitud</label><input id="admLng" type="number" step="0.0001" value="-74.8300"></div>
          <div><label>Radio (km)</label><input id="admRad" type="number" step="0.1" value="2.0"></div>
          <div><button id="btnAdmZona" class="btn-primary">Guardar zona</button></div>
        </div>
      </div>
    </div>
  </div>
  <script>
  // ==========================
  // CONFIGURACIÃ“N FIREBASE
  // ==========================
  const firebaseConfig = {
    apiKey: "AIzaSyAB4UlwaVJzc4U4VbmddLf4mejKAOvTufw",
    authDomain: "hornosapp-60887.firebaseapp.com",
    databaseURL: "https://hornosapp-60887-default-rtdb.firebaseio.com",
    projectId: "hornosapp-60887",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  // ==========================
  // VARIABLES GLOBALES
  // ==========================
  let usuarioActual = null;
  let rolActual = "user";
  let permisosActual = {
    planos:false, api:false, inventario:false, sinGeocerca:false
  };
  let zonaTecnoglass = {lat:11.0, lng:-74.83, radio_km:2};

  // ==========================
  // INICIO DE SESIÃ“N CON GOOGLE
  // ==========================
  const lblUser = document.getElementById("lblUser");
  const btnLogin = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");

  btnLogin.onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  };
  btnLogout.onclick = () => auth.signOut();

  auth.onAuthStateChanged(async (user)=>{
    if(user){
      usuarioActual = user;
      lblUser.textContent = user.email;
      btnLogin.classList.add("hidden");
      btnLogout.classList.remove("hidden");
      await inicializarUsuario(user.email);
    }else{
      usuarioActual=null;
      lblUser.textContent="â€”";
      btnLogin.classList.remove("hidden");
      btnLogout.classList.add("hidden");
      desactivarMenus();
    }
  });

  // ==========================
  // INICIALIZAR USUARIO
  // ==========================
  async function inicializarUsuario(email){
    const clave = email.replace(/\./g,"_").replace(/@/g,"_");
    const ref = db.ref("seguridad/usuarios/"+clave);
    const snap = await ref.once("value");
    let data = snap.val();

    if(!data){
      // crear usuario por defecto
      data = {
        autorizado:true,
        rol: email==="gary.maldonado@tecnoglass.com"?"superadmin":"user",
        zona:"TecnoglassBarranquilla",
        permisos:{planos:false,api:false,inventario:false,sinGeocerca:false}
      };
      await ref.set(data);
    }

    rolActual = data.rol || "user";
    permisosActual = data.permisos || {planos:false,api:false,inventario:false,sinGeocerca:false};

    // cargar zona
    const snapZ = await db.ref("seguridad/zonas/TecnoglassBarranquilla").once("value");
    if(snapZ.exists()) zonaTecnoglass = snapZ.val();

    verificarAcceso();
  }

  // ==========================
  // VERIFICAR ACCESO
  // ==========================
  async function verificarAcceso(){
    // superadmin tiene acceso total
    if(rolActual==="superadmin"){activarMenusTotal();return;}

    // geocerca
    if(!permisosActual.sinGeocerca){
      const dentro = await verificarZona();
      if(!dentro){
        alert("ðŸš« EstÃ¡s fuera del Ã¡rea permitida de Tecnoglass.");
        desactivarMenus();
        return;
      }
    }
    activarMenusPorPermiso();
  }

  // ==========================
  // GEOLOCALIZACIÃ“N
  // ==========================
  function distanciaKm(lat1, lon1, lat2, lon2){
    const R = 6371;
    const dLat = (lat2-lat1)*Math.PI/180;
    const dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 +
              Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }

  async function verificarZona(){
    return new Promise((resolve)=>{
      if(!navigator.geolocation){resolve(false);return;}
      navigator.geolocation.getCurrentPosition(pos=>{
        const d = distanciaKm(pos.coords.latitude,pos.coords.longitude,
                              zonaTecnoglass.lat,zonaTecnoglass.lng);
        resolve(d <= zonaTecnoglass.radio_km);
      },()=>resolve(false),{timeout:4000});
    });
  }

  // ==========================
  // ACTIVAR / DESACTIVAR MENÃšS
  // ==========================
  const drawerOpts = document.querySelectorAll(".drawer .opt");
  function desactivarMenus(){
    drawerOpts.forEach(o=>{
      o.style.opacity=".4";
      o.style.pointerEvents="none";
    });
  }

  function activarMenusTotal(){
    drawerOpts.forEach(o=>{
      o.style.opacity="1";
      o.style.pointerEvents="auto";
    });
    document.querySelectorAll(".admin-only").forEach(e=>e.style.display="block");
  }

  function activarMenusPorPermiso(){
    drawerOpts.forEach(o=>{o.style.opacity=".4";o.style.pointerEvents="none";});
    if(permisosActual.inventario){
      document.querySelector('[data-target="inventario"]').style.opacity="1";
      document.querySelector('[data-target="inventario"]').style.pointerEvents="auto";
    }
    if(permisosActual.planos){
      document.querySelector('[data-target="planos"]').style.opacity="1";
      document.querySelector('[data-target="planos"]').style.pointerEvents="auto";
    }
    document.querySelector('[data-target="temperaturas"]').style.opacity="1";
    document.querySelector('[data-target="temperaturas"]').style.pointerEvents="auto";
  }

  // ==========================
  // DRAWER MENÃš
  // ==========================
  const drawer = document.getElementById("drawer");
  const mask = document.getElementById("drawerMask");
  const btnMenu = document.getElementById("btnMenu");
  const btnCloseDrawer = document.getElementById("btnCloseDrawer");
  btnMenu.onclick = ()=>{drawer.classList.add("open");mask.style.display="block";};
  btnCloseDrawer.onclick = cerrarDrawer;
  mask.onclick = cerrarDrawer;
  function cerrarDrawer(){drawer.classList.remove("open");mask.style.display="none";}

  // NavegaciÃ³n
  const vistas=["view-temperaturas","view-inventario","view-planos","view-admin"];
  document.querySelectorAll(".drawer .opt").forEach(opt=>{
    opt.onclick=()=>{
      const target=opt.dataset.target;
      vistas.forEach(v=>document.getElementById(v).classList.add("hidden"));
      document.getElementById("view-"+target).classList.remove("hidden");
      cerrarDrawer();
    };
  });

  // ==========================
  // ADMIN PANEL (solo superadmin)
  // ==========================
  const admCorreo=$("#admCorreo"),admRol=$("#admRol"),admZona=$("#admZona");
  const admLat=$("#admLat"),admLng=$("#admLng"),admRad=$("#admRad");
  const btnAdmAgregar=$("#btnAdmAgregar"),btnAdmEliminar=$("#btnAdmEliminar"),btnAdmZona=$("#btnAdmZona");

  btnAdmAgregar.onclick=async()=>{
    if(rolActual!=="superadmin"){alert("Solo el superadmin puede editar.");return;}
    const email=admCorreo.value.trim().toLowerCase();if(!email)return;
    const key=email.replace(/\./g,"_").replace(/@/g,"_");
    const data={
      autorizado:true,
      rol:admRol.value,
      zona:admZona.value,
      permisos:{planos:true,api:true,inventario:true,sinGeocerca:false}
    };
    await db.ref("seguridad/usuarios/"+key).set(data);
    alert("Usuario guardado.");
  };

  btnAdmEliminar.onclick=async()=>{
    if(rolActual!=="superadmin"){alert("Solo el superadmin puede eliminar.");return;}
    const email=admCorreo.value.trim().toLowerCase();if(!email)return;
    const key=email.replace(/\./g,"_").replace(/@/g,"_");
    await db.ref("seguridad/usuarios/"+key).remove();
    alert("Usuario eliminado.");
  };

  btnAdmZona.onclick=async()=>{
    if(rolActual!=="superadmin"){alert("Solo el superadmin puede modificar zona.");return;}
    const zona={
      lat:parseFloat(admLat.value)||11.0,
      lng:parseFloat(admLng.value)||-74.83,
      radio_km:parseFloat(admRad.value)||2
    };
    await db.ref("seguridad/zonas/TecnoglassBarranquilla").set(zona);
    alert("Zona Tecnoglass actualizada.");
  };

  // util
  function $(sel){return document.querySelector(sel);}
  </script>
  <script>
  // ==========================
  // PLANOS (buscador + modal)
  // ==========================
  const tbodyPlanos = $("#tbodyPlanos");
  const buscarPlano = $("#buscarPlano");
  const modalInv = $("#modalInv");
  const framePlano = $("#framePlano");
  const mdTitulo = $("#mdTitulo");

  async function cargarPlanos(){
    try{
      const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTt0pEjemplo/pub?output=csv";
      const res = await fetch(url);
      const text = await res.text();
      const rows = text.split("\n").map(r=>r.split(","));
      tbodyPlanos.innerHTML="";
      rows.slice(1).forEach(r=>{
        const [nombre, , enlace] = r;
        if(!nombre || !enlace) return;
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${nombre}</td><td><button class='btn-outline'>Ver</button></td>`;
        tr.querySelector("button").onclick=()=>abrirPlano(nombre,enlace);
        tbodyPlanos.appendChild(tr);
      });
    }catch(e){console.error(e);}
  }
  cargarPlanos();

  function abrirPlano(nombre,url){
    mdTitulo.textContent = nombre;
    framePlano.src = url;
    modalInv.style.display="flex";
  }
  $("#btnCloseInv").onclick=()=>{
    modalInv.style.display="none";
    framePlano.src="";
  };
  $("#btnRecargarPlanos").onclick=cargarPlanos;

  buscarPlano.addEventListener("input",()=>{
    const filtro = buscarPlano.value.toLowerCase();
    for(const fila of tbodyPlanos.querySelectorAll("tr")){
      const nombre=fila.cells[0].textContent.toLowerCase();
      fila.style.display = nombre.includes(filtro)?"":"none";
    }
  });

  // ==========================
  // INVENTARIO (cards/tabla)
  // ==========================
  const listPend=$("#listPend");
  const btnVista=$("#btnVistaToggle");
  let vistaActual = localStorage.getItem("vistaInventario")||"cards";

  btnVista.onclick=()=>{
    vistaActual = vistaActual==="cards"?"tabla":"cards";
    localStorage.setItem("vistaInventario",vistaActual);
    mostrarInventario();
  };

  async function mostrarInventario(){
    const data = [
      {so:"SO123",item:"001",desc:"Perfil A",kg:2300},
      {so:"SO456",item:"002",desc:"Perfil B",kg:1500},
    ];
    let html="";
    if(vistaActual==="cards"){
      btnVista.textContent="ðŸ“‹ Vista Tabla";
      data.forEach(d=>{
        html+=`<div class='card'>
          <b>${d.desc}</b><br>SO:${d.so}-${d.item}<br>${d.kg} Kg
        </div>`;
      });
    }else{
      btnVista.textContent="ðŸ§± Vista Cards";
      html=`<table style='width:100%;border-collapse:collapse;text-align:center'>
        <thead><tr><th>SO</th><th>ITEM</th><th>DESCRIPCIÃ“N</th><th>KG</th></tr></thead><tbody>`;
      data.forEach(d=>{
        html+=`<tr><td>${d.so}</td><td>${d.item}</td><td>${d.desc}</td><td>${d.kg}</td></tr>`;
      });
      html+="</tbody></table>";
    }
    listPend.innerHTML=html;
  }
  mostrarInventario();

  $("#btnActualizarInv").onclick=()=>{
    alert("ðŸ”„ Datos del inventario actualizados (demo).");
    mostrarInventario();
  };

  // ==========================
  // REGISTRO DE TEMPERATURAS
  // ==========================
  const ctx=document.getElementById("chart");
  const chart=new Chart(ctx,{
    type:"line",
    data:{
      labels:["1 AM","2 AM","3 AM","4 AM","5 AM","6 AM"],
      datasets:[{
        label:"Temperatura (Â°C)",
        data:[380,385,390,400,405,398],
        borderColor:"#00e5ff",
        tension:0.3
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{labels:{color:"#fff"}}},
      scales:{
        x:{ticks:{color:"#fff"}},
        y:{ticks:{color:"#fff"}}
      }
    }
  });

  $("#btnNuevo").onclick=()=>{
    alert("ðŸ”¥ Nuevo ciclo iniciado (demo).");
  };

  // ==========================
  // FIN BLOQUE 3
  // ==========================
  </script>
</body>
</html>

